<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="UTF-8">
<title>POS Market ‚Äì Finance (Sugjerime 2-ditore) + Extended Features</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">

<!-- PWA manifest -->
<link rel="manifest" href="manifest.json">

<style>
body{margin:0;font-family:Segoe UI,Arial,Helvetica;background:#eef2f7}
header{background:#1e293b;color:#fff;padding:12px 15px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
nav button{margin:4px;padding:8px 10px;border:none;border-radius:8px;background:#334155;color:#fff;cursor:pointer}
section{display:none;padding:15px}
section.active{display:block}
.card{background:#fff;padding:15px;border-radius:12px;margin-bottom:12px;box-shadow:0 6px 14px rgba(0,0,0,.06)}
input,button,select,textarea{padding:8px;border-radius:8px;border:1px solid #cbd5f5}
button{background:#2563eb;color:#fff;font-weight:600;margin:3px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:6px;border-bottom:1px solid #e5e7eb;text-align:center}
th{background:#f1f5f9}
.admin{display:none}
.qtyBtn{padding:4px 8px}
.small{font-size:0.9em;color:#374151}
.kv{font-weight:600}
.row{display:flex;gap:8px;flex-wrap:wrap}
.col{flex:1;min-width:120px}
.datalist-input{width:100%;padding:8px;border-radius:8px;border:1px solid #cbd5f5}

/* FINANCE specific */
.finance-top{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.finance-metrics{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
.finance-metrics .box{background:#f8fafc;padding:10px;border-radius:8px;min-width:150px}
#deviceTime{font-size:0.95em;color:#dbeafe}

/* Sale preview */
.scan-preview{margin-top:8px;padding:12px;background:#fff;border-radius:8px;border:1px solid #e6eefc;box-shadow:0 4px 12px rgba(2,6,23,0.03)}
.scan-preview h4{margin:0 0 6px 0}
.preview-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.preview-col{flex:1;min-width:140px}
.preview-actions{margin-top:8px;text-align:right}
.preview-added{color:green;font-weight:700}
.preview-missing{color:#b45f00;font-weight:700}
.recent-scans{margin-top:8px;font-size:0.9em;color:#374151}

/* basic modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:999;align-items:center;justify-content:center}
.modal-content{background:#fff;margin:20px auto;padding:15px;width:95%;max-width:920px;border-radius:12px}
.small-modal .modal-content{max-width:520px}
.txn-list{margin:6px 0;padding-left:18px}
.txn-summary{margin-top:8px;font-weight:600}
.suggestion{background:#f8fafc;padding:8px;border-radius:8px;margin-top:6px}

/* LOW STOCK highlight */
.low-stock-row{background:linear-gradient(90deg, rgba(254,226,226,0.9), rgba(255,250,250,0.6)); border-left:6px solid #ef4444;}
.low-stock-badge{display:inline-block;background:#ef4444;color:#fff;padding:4px 8px;border-radius:999px;font-weight:700;margin-left:8px;font-size:0.85em}
.low-stock-top{margin-bottom:8px;color:#7f1d1d;font-weight:700}

/* small tables in finance */
.small-table{width:100%;border-collapse:collapse}
.small-table th, .small-table td{padding:6px;border:1px solid #eee;text-align:left}

/* Dashboard KPI */
.kpi{display:flex;gap:12px;flex-wrap:wrap}
.kpi .kpi-box{background:#fff;padding:10px;border-radius:8px;min-width:140px;box-shadow:0 4px 12px rgba(0,0,0,.04)}
</style>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- SheetJS for XLSX export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

<header>
  <div style="display:flex;gap:12px;align-items:center">
    <h2 style="margin:0">üõí POS Market</h2>
    <div id="deviceTime">--:--:--</div>
  </div>

  <nav id="menu" style="display:none">
    <button onclick="openSec('dash')" class="admin">Dashboard</button>
    <button onclick="openSec('prod')" class="admin">Stok</button>
    <button onclick="openSec('sale')">Shitje</button>
    <button onclick="openSec('bil')" class="admin">Bilanc</button>
    <button onclick="openSec('hist')">Historik</button>
    <button onclick="openSec('fin')" class="admin">Financa</button>
    <button onclick="openSec('sync')" class="admin">Sync</button>
    <button onclick="openAudit()" class="admin">Audit</button>
    <button onclick="openBackup()" class="admin">Backup/Restore</button>
    <button onclick="logout()">Dil</button>
  </nav>
</header>

<!-- LOGIN -->
<section id="loginSec" class="active">
<div class="card">
<h3>Login</h3>
<input id="u" placeholder="User">
<input id="p" type="password">
<div style="margin-top:8px">
<button onclick="doLogin()">Hyr</button>
</div>
<p id="msg" style="color:red"></p>
</div>
</section>

<!-- DASHBOARD -->
<section id="dash">
<div class="card">
<h3>Dashboard</h3>
<div class="kpi">
  <div class="kpi-box"><div class="small">T√´ ardhurat (7d)</div><div id="kpiRev" class="kv">0 ALL</div></div>
  <div class="kpi-box"><div class="small">Shitje sot</div><div id="kpiToday" class="kv">0 ALL</div></div>
  <div class="kpi-box"><div class="small">Top produkt</div><div id="kpiTop" class="kv">--</div></div>
  <div class="kpi-box"><div class="small">Produkte me stok t√´ ul√´t</div><div id="kpiLow" class="kv">0</div></div>
</div>
<div style="margin-top:12px">
  <h4>Grafik 14-ditor</h4>
  <canvas id="dashChart"></canvas>
</div>
</div>
</section>

<!-- STOK -->
<section id="prod">
<div class="card admin">
<h3>Shto Produkt</h3>
<div class="row">
<input id="pn" placeholder="Emri" class="col">
<input id="pb" placeholder="Barkodi (unik)" class="col">
</div>
<div class="row" style="margin-top:8px">
<input id="pp" type="number" placeholder="√ámimi Shitje (ALL)" class="col">
<input id="pcost" type="number" placeholder="√ámimi Blerje (ALL)" class="col">
<input id="ps" type="number" placeholder="Sasia" class="col">
</div>
<div style="margin-top:8px">
<button onclick="addProduct()">‚ûï Shto</button>
<button onclick="exportProductsXLSX()">‚¨áÔ∏è Eksporto Produkte (XLSX)</button>
<button onclick="openStockTake()">üìã Stock Take</button>
</div>
</div>
<div id="lowStockNotice" class="low-stock-top" style="display:none"></div>
<table id="prodTable"></table>
</section>

<!-- SHITJE -->
<section id="sale">
<div class="card" id="saleTopCard">
<div class="row">
<input id="saleScan" list="prodNames" placeholder="Em√´r / Barkod / Scan USB" autofocus class="col datalist-input">
<datalist id="prodNames"></datalist>
<input id="client" placeholder="Emri i klientit (opsional)" class="col">
</div>
<div style="margin-top:8px">
<button onclick="manualAdd()">‚ûï Shto</button>
<label style="margin-left:8px"><input type="checkbox" id="scannerMode"> Scanner HID auto</label>
</div>

<div id="scanPreview" class="scan-preview">
  <h4>Preview skanimi</h4>
  <div id="previewContent" class="preview-row">
    <div class="preview-col">Kodi: <b id="previewCode">--</b></div>
    <div class="preview-col">Produkt: <b id="previewName">--</b></div>
    <div class="preview-col">√ámim: <b id="previewPrice">--</b></div>
    <div class="preview-col">Stok: <b id="previewStock">--</b></div>
  </div>
  <div class="preview-actions" id="previewActions"></div>
  <div class="recent-scans" id="recentScans">Skanime t√´ fundit: --</div>
</div>
</div>

<div class="card">
<table id="saleTable"></table>
<div style="margin-top:8px" id="discountInfo" class="small"></div>
<h3>Total: <span id="tot">0</span> ALL</h3>
<div style="display:flex;gap:8px;align-items:center">
  <input id="paid" type="number" placeholder="Lek√´ nga klienti">
  <button onclick="applyPromo()">ü™≤ Apliko Promo (manual)</button>
</div>
<h3>Kusur / Munges√´: <span id="change">0</span></h3>
<div style="margin-top:8px">
  <button onclick="pay()">Paguaj</button>
  <button onclick="cancel()">Anulo</button>
</div>
</div>
</section>

<!-- STOCK TAKE MODAL -->
<div class="modal" id="stockModal">
  <div class="modal-content">
    <h3>Stock Take ‚Äî Vendos sasi t√´ num√´ruara</h3>
    <div id="stockTakeList" style="max-height:400px;overflow:auto"></div>
    <div style="margin-top:8px;text-align:right">
      <button onclick="confirmStockTake()">P√´rdit√´so Stok</button>
      <button onclick="closeStockTake()">Mbyll</button>
    </div>
  </div>
</div>

<!-- BILANC -->
<section id="bil" class="admin">
<div class="card">
<h3>Bilanci Ditor</h3>
<p>Sistemi: <b><span id="daily">0</span> ALL</b></p>
<p class="small">(Kjo √´sht√´ shuma e parave t√´ ark√´tuara gjat√´ dit√´s)</p>
<input id="cashReal" type="number" placeholder="Shuma reale n√´ ark√´">
<p>Diferenca: <b><span id="diff">0</span></b></p>
<div style="margin-top:8px">
<button onclick="closeDay()">Mbyll Dit√´n</button>
<button onclick="exportClosuresXLSX()">‚¨áÔ∏è Eksporto Mbylljet (XLSX)</button>
</div>
</div>
</section>

<!-- HISTORIK -->
<section id="hist">
<div class="card">
<h3>Historiku i Shitjeve</h3>
<div style="margin-bottom:8px">
<button onclick="exportSalesXLSX()">‚¨áÔ∏è Eksporto Shitjet (XLSX)</button>
<button onclick="clearOld()">üßπ Fshi t√´ gjitha (lokal)</button>
</div>
<table id="histTable"></table>
</div>
</section>

<!-- FINANCE (without incomes) -->
<section id="fin" class="admin">
  <div class="card">
    <h3>FINANCA ‚Äî Raport & Instrumente</h3>

    <div class="finance-top">
      <div>
        <label class="small">Nga</label><br>
        <input id="finFrom" type="date">
      </div>
      <div>
        <label class="small">Deri</label><br>
        <input id="finTo" type="date">
      </div>
      <div style="margin-left:auto">
        <label class="small">Ora pajisjes</label><br>
        <div id="finDeviceTime" class="small">--:--:--</div>
      </div>
      <div><br><button onclick="updateFinance()">P√´rdit√´so Raport</button></div>
    </div>

    <div class="finance-metrics">
      <div class="box">
        <div class="small">T√´ ardhurat (shitjet)</div>
        <div id="finRevenue" class="kv">0 ALL</div>
      </div>
      <div class="box">
        <div class="small">COGS (nga blerja)</div>
        <div id="finCOGS" class="kv">0 ALL</div>
      </div>
      <div class="box">
        <div class="small">Fitim Bruto</div>
        <div id="finProfit" class="kv">0 ALL</div>
        <div id="finMargin" class="small">Margin√´: 0%</div>
      </div>
      <div class="box">
        <div class="small">Shpenzime (gjithsej)</div>
        <div id="finExpenses" class="kv">0 ALL</div>
      </div>
      <div class="box">
        <div class="small">Fitim Neto</div>
        <div id="finNetProfit" class="kv">0 ALL</div>
      </div>
      <div class="box">
        <div class="small">TVSH (%)</div>
        <div><input id="vatRate" type="number" style="width:80px" min="0" step="0.1"></div>
        <div id="finVAT" class="small">TVSH: 0 ALL</div>
      </div>
    </div>

    <div style="margin-top:12px">
      <h4>Grafik: T√´ ardhurat vs Fitimi (per periudh√´)</h4>
      <canvas id="finChart"></canvas>
    </div>

    <hr>

    <div style="margin-top:12px">
      <h4>Menaxho Shpenzime</h4>
      <div class="row">
        <input id="expDesc" placeholder="P√´rshkrim" class="col">
        <input id="expAmount" type="number" placeholder="Shuma (ALL)">
        <select id="expCategory">
          <option value="other">Other</option>
          <option value="salary">Salary</option>
          <option value="tax">Tax</option>
        </select>
        <input id="expDate" type="date">
        <button onclick="addExpense()">‚ûï Regjistro Shpenzim</button>
      </div>
      <div style="margin-top:8px">
        <button onclick="exportExpensesXLSX()">‚¨áÔ∏è Eksporto Shpenzime (XLSX)</button>
      </div>
      <div id="expensesList" style="margin-top:8px"></div>
    </div>

    <hr>

    <div style="margin-top:12px">
      <h4>Plan p√´r Qira & Borxhe</h4>
      <div class="row">
        <input id="rentMonthly" type="number" placeholder="Qira mujore (ALL)" class="col">
        <input id="debtTotal" type="number" placeholder="Borxhi total (ALL)" class="col">
        <input id="debtDueDays" type="number" placeholder="Dit√´ p√´r ta shlyer (p.sh.30)" class="col">
        <button onclick="saveRentDebt()">Ruaj</button>
      </div>
      <div style="margin-top:8px">
        <button onclick="computeSavingsPlan()">Llogarit sa t√´ kursosh</button>
        <button onclick="exportSavingsXLSX()">‚¨áÔ∏è Eksporto Planin (XLSX)</button>
      </div>
      <div id="savingsResult" style="margin-top:10px"></div>
    </div>

    <hr>

    <div style="margin-top:12px">
      <h4>Promotions / Discounts</h4>
      <div class="row">
        <input id="promoBarcode" placeholder="Barkod produkti (lini bosh p√´r global)" class="col">
        <select id="promoType"><option value="percent">P√´rqindje</option><option value="amount">Adres√´</option><option value="bogo">BOGO (Buy X Get Y)</option></select>
        <input id="promoVal" placeholder="v (p.sh.10 p√´r 10% ose 50 p√´r 50 ALL)" class="col">
        <input id="promoMinQty" type="number" placeholder="Min qty (BOGO p√´rdor si X)" style="width:120px">
        <button onclick="addPromo()">‚ûï Ruaj Promo</button>
      </div>
      <div style="margin-top:8px">
        <button onclick="exportPromosXLSX()">‚¨áÔ∏è Eksporto Promos (XLSX)</button>
      </div>
      <div id="promoList" style="margin-top:8px"></div>
    </div>

    <hr>

    <div style="margin-top:12px">
      <h4>Analiz√´ ‚Äî Top Produkte (periudha)</h4>
      <div id="topProducts"></div>
    </div>

    <hr>

    <div style="margin-top:12px">
      <h4>Monthly report p√´r pronar/funder</h4>
      <div class="row">
        <input id="reportMonth" type="month">
        <button onclick="exportMonthlyReportXLSX()">üîΩ Eksporto Raport Mujor (XLSX)</button>
      </div>
    </div>

  </div>
</section>

<!-- SYNC / MULTI-STORE (stub) -->
<section id="sync" class="admin">
  <div class="card">
    <h3>Multi-store / Sync</h3>
    <p class="small">Konfiguroni endpoint backend (REST) p√´r sinkronizim. Kjo √´sht√´ implementim baz√´ - k√´rkon backend p√´r t√´ punuar.</p>
    <div class="row">
      <input id="syncUrl" placeholder="https://your-backend.example/sync" class="col">
      <button onclick="syncNow()">üîÑ Sync Now</button>
    </div>
    <div id="syncResult" style="margin-top:8px"></div>
  </div>
</section>

<!-- AUDIT LOG modal -->
<div class="modal" id="auditModal">
  <div class="modal-content">
    <h3>Audit Log</h3>
    <div style="margin-top:8px">
      <button onclick="exportAuditXLSX()">‚¨áÔ∏è Eksporto Audit (XLSX)</button>
      <button onclick="clearAudit()">üßπ Fshi Audit</button>
    </div>
    <div id="auditList" style="max-height:500px;overflow:auto;margin-top:8px"></div>
    <div style="margin-top:12px;text-align:right">
      <button onclick="closeAudit()">Mbyll</button>
    </div>
  </div>
</div>

<!-- BACKUP / RESTORE modal -->
<div class="modal" id="backupModal">
  <div class="modal-content">
    <h3>Backup / Restore localStorage</h3>
    <div style="margin-top:8px">
      <button onclick="exportBackup()">‚¨áÔ∏è Eksporto Backup (JSON)</button>
      <input id="backupFile" type="file" accept=".json">
      <button onclick="importBackup()">üîº Import Backup</button>
    </div>
    <div style="margin-top:12px;text-align:right">
      <button onclick="closeBackup()">Mbyll</button>
    </div>
  </div>
</div>

<!-- VIEW / PAY DEBT MODAL -->
<div class="modal" id="viewModal" style="display:none">
<div class="modal-content" id="viewContent">
<h3>Detajet e Shitjes</h3>
<div id="viewBody"></div>
<div style="margin-top:12px">
<input id="settleAmount" type="number" placeholder="Shuma p√´r t√´ shlyer (ALL)">
<button onclick="settleDebt()">Shlyej Borxh</button>
<button onclick="printCurrentReceipt()">üñ®Ô∏è Print</button>
<button onclick="closeView()">Mbyll</button>
</div>
</div>
</div>

<!-- TRANSACTION SUCCESS MODAL (small) -->
<div class="modal" id="txnModal" style="display:none">
<div class="modal-content small-modal">
<h4 id="txnTitle">Transaksioni</h4>
<div id="txnMsg" class="small"></div>
<div style="margin-top:12px;text-align:right">
<button onclick="printCurrentReceipt()">üñ®Ô∏è Print</button>
<button onclick="closeTxn()">Mbyll</button>
</div>
</div>
</div>

<script>
/* ======= CONFIG & STORAGE KEYS ======= */
const KEY_PRODUCTS = 'p';
const KEY_SALES_HISTORY = 'salesHistory';
const KEY_DAILY = 'daily';
const KEY_RECENT_SCANS = 'recentScans';
const KEY_EXPENSES = 'expenses';
const KEY_VAT = 'vatRate';
const KEY_CLOSURES = 'dayClosures';
const KEY_RENT = 'rentMonthly';
const KEY_DEBT = 'debtTotal';
const KEY_DEBT_DAYS = 'debtDueDays';
const KEY_LAST_SUGGEST = 'lastSuggestTS';
const KEY_AUDIT = 'auditLog';
const KEY_PROMOS = 'promotions';
const KEY_SCANNER_SETTINGS = 'scannerSettings';
const KEY_LAST_PLAN = 'lastSavingsPlan';

/* ======= STATE ======= */
const users=[{u:'admin',p:'admin',r:'admin'},{u:'kasier',p:'kasier',r:'kasier'}];
let currentUser = null; // username
let role=null;
let products = JSON.parse(localStorage.getItem(KEY_PRODUCTS) || '[]');
let sales = [];
let salesHistory = JSON.parse(localStorage.getItem(KEY_SALES_HISTORY) || '[]');
let daily = +localStorage.getItem(KEY_DAILY) || 0;
let finChart = null;
let expenses = JSON.parse(localStorage.getItem(KEY_EXPENSES) || '[]');
let vatRate = Number(localStorage.getItem(KEY_VAT) || 0);
let promotions = JSON.parse(localStorage.getItem(KEY_PROMOS) || '[]');
let scannerSettings = JSON.parse(localStorage.getItem(KEY_SCANNER_SETTINGS) || '{"threshold":50,"enabled":false}') || {threshold:50, enabled:false};
let lastSaleRecord = null; // for printing

/* rent/debt settings */
let rentMonthly = Number(localStorage.getItem(KEY_RENT) || 0);
let debtTotal = Number(localStorage.getItem(KEY_DEBT) || 0);
let debtDueDays = Number(localStorage.getItem(KEY_DEBT_DAYS) || 30);

/* LOW STOCK threshold */
const LOW_STOCK_THRESHOLD = 1;

/* ======= ELEMENTS ======= */
const deviceTimeEl = document.getElementById('deviceTime');
const finDeviceTimeEl = document.getElementById('finDeviceTime');
const saleScanEl = document.getElementById('saleScan');
const paidEl = document.getElementById('paid');
const totEl = document.getElementById('tot');
const changeEl = document.getElementById('change');
const prodTableEl = document.getElementById('prodTable');
const saleTableEl = document.getElementById('saleTable');
const histTableEl = document.getElementById('histTable');
const dailyEl = document.getElementById('daily');
const cashRealEl = document.getElementById('cashReal');
const diffEl = document.getElementById('diff');
const txnModalEl = document.getElementById('txnModal');
const txnMsgEl = document.getElementById('txnMsg');
const txnTitleEl = document.getElementById('txnTitle');
const previewCodeEl = document.getElementById('previewCode');
const previewNameEl = document.getElementById('previewName');
const previewPriceEl = document.getElementById('previewPrice');
const previewStockEl = document.getElementById('previewStock');
const previewActionsEl = document.getElementById('previewActions');
const recentScansEl = document.getElementById('recentScans');
const lowStockNoticeEl = document.getElementById('lowStockNotice');
const vatRateEl = document.getElementById('vatRate');
const expensesListEl = document.getElementById('expensesList');
const topProductsEl = document.getElementById('topProducts');
const savingsResultEl = document.getElementById('savingsResult');
const suggestModalEl = document.getElementById('suggestModal');
const suggestBodyEl = document.getElementById('suggestBody');
const promoListEl = document.getElementById('promoList');
const prodNamesDatalist = document.getElementById('prodNames');

/* ======= UTILITIES ======= */
function nowISO(){ return new Date().toISOString(); }
function escapeHtml(str){ return ('' + (str || '')).replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

/* ======= AUDIT LOG ======= */
function logAudit(action, entity, details = {}){
  const user = currentUser || 'unknown';
  const list = JSON.parse(localStorage.getItem(KEY_AUDIT) || '[]');
  const entry = { ts: nowISO(), user, action, entity, details };
  list.unshift(entry);
  localStorage.setItem(KEY_AUDIT, JSON.stringify(list));
}
function openAudit(){
  const modal = document.getElementById('auditModal');
  renderAudit();
  modal.style.display = 'flex';
}
function closeAudit(){ document.getElementById('auditModal').style.display = 'none'; }
function renderAudit(){
  const list = JSON.parse(localStorage.getItem(KEY_AUDIT) || '[]');
  const el = document.getElementById('auditList');
  if(!list.length){ el.innerHTML = '<div class="small">Nuk ka aktivitete audit.</div>'; return; }
  let html = '<ul class="txn-list">';
  list.slice(0,200).forEach(a => {
    html += `<li><b>${escapeHtml(a.action)}</b> ‚Äî ${escapeHtml(a.entity)} ‚Äî ${escapeHtml(JSON.stringify(a.details))} <div class="small">nga: ${escapeHtml(a.user)} ‚Ä¢ ${a.ts.replace('T',' ').slice(0,19)}</div></li>`;
  });
  html += '</ul>';
  el.innerHTML = html;
}
function clearAudit(){
  if(!confirm('Fshi gjith√´ audit log?')) return;
  localStorage.removeItem(KEY_AUDIT);
  renderAudit();
}

/* ======= BACKUP / RESTORE ======= */
function openBackup(){ document.getElementById('backupModal').style.display = 'flex'; }
function closeBackup(){ document.getElementById('backupModal').style.display = 'none'; }
function exportBackup(){
  const dump = {};
  for(let i=0;i<localStorage.length;i++){ const k = localStorage.key(i); dump[k] = localStorage.getItem(k); }
  const blob = new Blob([JSON.stringify(dump, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `pos_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
}
function importBackup(){
  const f = document.getElementById('backupFile').files[0];
  if(!f) return alert('Zgjidh file JSON p√´r import');
  const reader = new FileReader();
  reader.onload = e => {
    try{
      const obj = JSON.parse(e.target.result);
      if(!confirm('Ky import do e z√´vend√´soj√´ localStorage aktual. Vazhdoni?')) return;
      Object.keys(obj).forEach(k => localStorage.setItem(k, obj[k]));
      // reload in-memory
      products = JSON.parse(localStorage.getItem(KEY_PRODUCTS) || '[]');
      salesHistory = JSON.parse(localStorage.getItem(KEY_SALES_HISTORY) || '[]');
      expenses = JSON.parse(localStorage.getItem(KEY_EXPENSES) || '[]');
      promotions = JSON.parse(localStorage.getItem(KEY_PROMOS) || '[]');
      renderProducts(); renderHistory(); renderExpenses(); renderPromos(); updateFinance(); initFinanceChart();
      alert('Import u krye. Rifresko faqen n√´se nevojitet.');
    }catch(err){ alert('Skedari nuk √´sht√´ valid JSON'); console.error(err); }
  };
  reader.readAsText(f);
}

/* ======= SheetJS helpers ======= */
function saveXLSX(sheets, filename){
  // sheets: { sheetName: [{col1:val1, ...}, ... ], ... }
  const wb = XLSX.utils.book_new();
  for(const name in sheets){
    const data = sheets[name];
    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, name);
  }
  XLSX.writeFile(wb, filename);
}

/* ======= EXPORTS (XLSX) ======= */
function exportProductsXLSX(){
  const data = products.map(p => ({name:p.n||'', barcode:p.b||'', price:p.p||0, purchase_price:p.purchase_price||0, stock:p.s||0}));
  saveXLSX({Products:data}, `products_${new Date().toISOString().slice(0,10)}.xlsx`);
}
function exportSalesXLSX(){
  const rows = salesHistory.map(s => ({id:s.id, ts:s.timestamp, client:s.client||'', total:s.total, paid:s.amountPaid, due:s.due, status:s.status}));
  saveXLSX({Sales:rows}, `sales_${new Date().toISOString().slice(0,10)}.xlsx`);
}
function exportExpensesXLSX(){
  const data = expenses.map(e => ({id:e.id, date:e.date, desc:e.desc, category:e.category, amount:e.amount}));
  saveXLSX({Expenses:data}, `expenses_${new Date().toISOString().slice(0,10)}.xlsx`);
}
function exportClosuresXLSX(){
  const closures = JSON.parse(localStorage.getItem(KEY_CLOSURES)||'[]');
  saveXLSX({Closures:closures}, `closures_${new Date().toISOString().slice(0,10)}.xlsx`);
}
function exportPromosXLSX(){
  saveXLSX({Promotions:promotions}, `promotions_${new Date().toISOString().slice(0,10)}.xlsx`);
}
function exportAuditXLSX(){
  const audit = JSON.parse(localStorage.getItem(KEY_AUDIT) || '[]');
  saveXLSX({Audit:audit}, `audit_${new Date().toISOString().slice(0,10)}.xlsx`);
}
function exportSavingsXLSX(){
  const plan = JSON.parse(localStorage.getItem(KEY_LAST_PLAN) || '{}');
  saveXLSX({SavingsPlan:[plan]}, `savings_plan_${new Date().toISOString().slice(0,10)}.xlsx`);
}
function exportFinanceXLSX(){
  const from = document.getElementById('finFrom').value || null;
  const to = document.getElementById('finTo').value || null;
  const revenue = computeRevenue(from,to);
  const cogs = computeCOGS_from_stock(from,to);
  const profitBefore = revenue - cogs;
  const expensesTotal = computeExpenses(from,to);
  const netProfit = profitBefore - expensesTotal;
  const vat = revenue * (Number(vatRate) || 0) / 100;
  const rows = [{metric:'revenue', value:revenue},{metric:'cogs',value:cogs},{metric:'profit_before',value:profitBefore},{metric:'expenses',value:expensesTotal},{metric:'net_profit',value:netProfit},{metric:'vat',value:Math.round(vat)}];
  saveXLSX({Finance:rows}, `finance_${new Date().toISOString().slice(0,10)}.xlsx`);
}

/* ======= PROMOTIONS / DISCOUNTS ======= */
function renderPromos(){
  const el = promoListEl;
  if(!promotions.length){ el.innerHTML = '<div class="small">Nuk ka promos</div>'; return; }
  let html = '<ul class="txn-list">';
  promotions.forEach(p => html += `<li><b>${p.type}</b> ‚Ä¢ ${p.barcode||'GLOBAL'} ‚Ä¢ v:${p.value} ‚Ä¢ minQty:${p.minQty||0} <button onclick="removePromo('${p.id}')">üóëÔ∏è</button></li>`);
  html += '</ul>';
  el.innerHTML = html;
}
function addPromo(){
  const barcode = document.getElementById('promoBarcode').value.trim();
  const type = document.getElementById('promoType').value;
  const value = Number(document.getElementById('promoVal').value) || 0;
  const minQty = Number(document.getElementById('promoMinQty').value) || 0;
  if(type !== 'bogo' && value <= 0) return alert('Vendos vler√´ promo');
  const rec = { id: nowISO() + '_' + Math.random().toString(36).slice(2,6), barcode: barcode || null, type, value, minQty };
  promotions.push(rec);
  localStorage.setItem(KEY_PROMOS, JSON.stringify(promotions));
  document.getElementById('promoBarcode').value=''; document.getElementById('promoVal').value=''; document.getElementById('promoMinQty').value='';
  renderPromos();
  logAudit('add_promo', 'promo', rec);
}
function removePromo(id){
  if(!confirm('Fshi k√´t√´ promo?')) return;
  promotions = promotions.filter(p=>p.id !== id);
  localStorage.setItem(KEY_PROMOS, JSON.stringify(promotions));
  renderPromos();
  logAudit('remove_promo','promo',{id});
}

/* Apply applicable promotions to sales - returns discount total and details */
function calculatePromosForSale(){
  let discount = 0;
  const details = [];
  sales.forEach(item => {
    // find promos matching product or global
    const applicable = promotions.filter(p => !p.barcode || p.barcode === item.b);
    applicable.forEach(p => {
      if(p.type === 'percent' && item.q >= (p.minQty||1)){
        const d = Math.round(item.p * item.q * (p.value/100));
        discount += d;
        details.push({id:p.id, type:p.type, d});
      } else if(p.type === 'amount' && item.q >= (p.minQty||1)){
        const d = Math.round(p.value * item.q);
        discount += d;
        details.push({id:p.id, type:p.type, d});
      } else if(p.type === 'bogo' && item.q >= (p.minQty||2)){
        // simple BOGO: for each minQty bought, give floor(q/minQty) * freeQty (value is freeQty)
        const groups = Math.floor(item.q / p.minQty);
        const free = groups * (p.value || 1);
        const d = Math.round(Math.min(free, item.q) * item.p);
        discount += d;
        details.push({id:p.id, type:p.type, d, free});
      }
    });
  });
  return {discount, details};
}

/* Apply manual promo button (recalculate) */
function applyPromo(){
  drawSale(); // will compute discount
}

/* ======= PRODUCTS (store purchase_price in stock) ======= */
function renderProducts(){
  // rebuild datalist for autocomplete
  prodNamesDatalist.innerHTML = '';
  products.forEach(p => {
    const o = document.createElement('option'); o.value = p.n || p.b || '';
    prodNamesDatalist.appendChild(o);
  });

  const low = [], normal = [];
  products.forEach(p => { if(Number(p.s) <= LOW_STOCK_THRESHOLD) low.push(p); else normal.push(p); });
  const ordered = low.concat(normal);

  prodTableEl.innerHTML = '<tr><th>Em√´r</th><th>Barkod</th><th>√ámim Shitje</th><th>√ámimi Blerje</th><th>Stok</th><th>Veprime</th></tr>';
  ordered.forEach((p,i)=>{
    const origIndex = products.indexOf(p);
    const lowClass = Number(p.s) <= LOW_STOCK_THRESHOLD ? 'low-stock-row' : '';
    prodTableEl.innerHTML += `
      <tr class="${lowClass}">
        <td><input value="${escapeHtml(p.n || '')}" onchange="editProduct(${origIndex},'n',this.value)"></td>
        <td><input value="${escapeHtml(p.b || '')}" onchange="editProduct(${origIndex},'b',this.value)"></td>
        <td><input type="number" value="${p.p || 0}" onchange="editProduct(${origIndex},'p',+this.value)"></td>
        <td><input type="number" value="${p.purchase_price || 0}" onchange="editProduct(${origIndex},'purchase_price',+this.value)"></td>
        <td><input type="number" value="${p.s || 0}" onchange="editProduct(${origIndex},'s',+this.value)"></td>
        <td><button onclick="deleteProduct(${origIndex})">üóëÔ∏è</button></td>
      </tr>`;
  });

  const lowCount = products.filter(p => Number(p.s) <= LOW_STOCK_THRESHOLD).length;
  if(lowCount > 0){
    lowStockNoticeEl.style.display = 'block';
    lowStockNoticeEl.innerHTML = `Produkte me stok t√´ ul√´t: <span class="low-stock-badge">${lowCount}</span> (‚â§ ${LOW_STOCK_THRESHOLD})`;
  } else {
    lowStockNoticeEl.style.display = 'none';
    lowStockNoticeEl.innerHTML = '';
  }
}
function editProduct(i, field, value){
  const old = Object.assign({}, products[i]);
  products[i][field] = value;
  localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products));
  renderProducts();
  initFinanceChart();
  logAudit('edit_product','product',{index:i, field, old, new:products[i], user:currentUser});
}
function addProduct(){
  const name = (document.getElementById('pn').value || '').trim();
  const barcode = (document.getElementById('pb').value || '').trim();
  const price = Number(document.getElementById('pp').value) || 0;
  const purchase_price = Number(document.getElementById('pcost').value) || 0;
  const qty = Number(document.getElementById('ps').value) || 0;
  if(!name) return alert('Emri i produktit √´sht√´ i detyruesh√´m');
  if(price <= 0) return alert('√ámimi i shitjes duhet > 0');
  if(purchase_price <= 0) return alert('√ámimi i blerjes duhet > 0');
  if(barcode && products.find(p=>p.b === barcode)) return alert('Barkod ekziston');
  const rec = { n: name, b: barcode, p: price, purchase_price: purchase_price, s: qty };
  products.push(rec);
  localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products));
  document.getElementById('pn').value=''; document.getElementById('pb').value=''; document.getElementById('pp').value=''; document.getElementById('pcost').value=''; document.getElementById('ps').value='';
  renderProducts();
  initFinanceChart();
  logAudit('add_product','product',rec);
}
function deleteProduct(i){
  if(!confirm('Fshi k√´t√´ produkt?')) return;
  const removed = products.splice(i,1)[0];
  localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products));
  renderProducts();
  logAudit('delete_product','product',removed);
}

/* ======= SALES ======= */
function findProductByKey(key){
  if(!key) return null;
  key = key.toString().trim().toLowerCase();
  return products.find(p => p.b && p.b.toString().toLowerCase() === key)
    || products.find(p => (p.n || '').toString().toLowerCase() === key)
    || products.find(p => (p.n || '').toString().toLowerCase().includes(key));
}
function addToSale(p){
  if(p.s < 1) return alert('Stoku = 0');
  let s = sales.find(x=>x.b===p.b);
  if(s){
    if(s.q + 1 > p.s) return alert('Sasia tejkalon stoqen');
    s.q++;
  } else {
    sales.push({ b: p.b, n: p.n, p: p.p, q: 1 });
  }
  drawSale();
}
function manualAdd(){
  let v = saleScanEl.value.trim();
  if(!v) return;
  const p = findProductByKey(v);
  if(!p){
    showPreview(v,null,false);
    return alert('Nuk u gjet');
  }
  addToSale(p);
  showPreview(v,p,true);
  saleScanEl.value=''; saleScanEl.focus();
}
saleScanEl.addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    e.preventDefault();
    const v = saleScanEl.value.trim();
    if(!v) return;
    const p = products.find(p=>p.b && p.b.toString() === v) || findProductByKey(v);
    if(p){
      addToSale(p);
      logRecentScan(v, p);
      showPreview(v, p, true);
      saleScanEl.value='';
      saleScanEl.focus();
    } else {
      showPreview(v, null, false);
    }
  }
});

function drawSale(){
  const {discount, details} = calculatePromosForSale();
  saleTableEl.innerHTML = '<tr><th>Produkt</th><th>Sasi</th><th>√ámim</th><th>Subtotal</th><th></th></tr>';
  sales.forEach((x,i)=> {
    saleTableEl.innerHTML += `
      <tr>
        <td>${escapeHtml(x.n)}</td>
        <td><button class="qtyBtn" onclick="changeQty(${i},-1)">‚ûñ</button> ${x.q} <button class="qtyBtn" onclick="changeQty(${i},1)">‚ûï</button></td>
        <td>${x.p}</td>
        <td>${x.q * x.p}</td>
        <td><button onclick="sales.splice(${i},1);drawSale();">üóëÔ∏è</button></td>
      </tr>`;
  });
  const discountText = discount > 0 ? ` ‚Äî Promo discount: ${discount} ALL` : '';
  document.getElementById('discountInfo').innerText = discountText;
  recalc();
}
function changeQty(i,delta){
  const item = sales[i]; if(!item) return;
  const prod = products.find(p=>p.b === item.b);
  item.q += delta;
  if(item.q < 1) { sales.splice(i,1); }
  if(prod && item.q > prod.s){ item.q = prod.s; alert('Sasia tejkalon stoqen'); }
  drawSale();
}
function recalc(){
  let total = 0; sales.forEach(x=> total += x.q * x.p);
  const {discount} = calculatePromosForSale();
  const totalAfter = Math.max(0, total - discount);
  totEl.textContent = totalAfter;
  const cash = (+paidEl.value || 0);
  const diff = cash - totalAfter;
  if(diff < 0){ changeEl.textContent = `Mungojn√´ ${Math.abs(diff)} ALL`; changeEl.style.color = 'red'; }
  else { changeEl.textContent = `Kusur ${diff} ALL`; changeEl.style.color = 'green'; }
}
paidEl.addEventListener('input', recalc);

/* ======= PREVIEW / RECENT SCANS ======= */
let recentScans = JSON.parse(localStorage.getItem(KEY_RECENT_SCANS) || '[]');
function updateRecentScansUI(){
  if(!recentScans.length){ recentScansEl.textContent = 'Skanime t√´ fundit: --'; return; }
  recentScansEl.textContent = 'Skanime t√´ fundit: ' + recentScans.slice(-6).reverse().map(s=> `${s.code}${s.name? ' ('+s.name+')':''}` ).join(' ‚Ä¢ ');
}
function logRecentScan(code, product){
  recentScans.push({ts:nowISO(), code, name: product ? product.n : null});
  if(recentScans.length > 50) recentScans.shift();
  localStorage.setItem(KEY_RECENT_SCANS, JSON.stringify(recentScans));
  updateRecentScansUI();
}
function showPreview(code, product, added){
  previewCodeEl.textContent = code || '--';
  previewNameEl.textContent = product ? product.n : '--';
  previewPriceEl.textContent = product ? (product.p + ' ALL') : '--';
  previewStockEl.textContent = product ? product.s : '--';
  previewActionsEl.innerHTML = '';
  if(added){
    previewActionsEl.innerHTML = `<span class="preview-added">U shtua 1 cop√´</span> <button onclick="clearPreview()">Anulo</button>`;
    if(code) logRecentScan(code, product);
  } else {
    if(product){
      previewActionsEl.innerHTML = `<button onclick="previewAdd('${escapeForAttr(code)}')">Shto 1</button> <button onclick="clearPreview()">Anulo</button>`;
    } else {
      previewActionsEl.innerHTML = `<span class="preview-missing">Produkt nuk u gjet</span> <button onclick="clearPreview()">Anulo</button>`;
      if(code) logRecentScan(code, null);
    }
  }
}
function clearPreview(){
  previewCodeEl.textContent = '--';
  previewNameEl.textContent = '--';
  previewPriceEl.textContent = '--';
  previewStockEl.textContent = '--';
  previewActionsEl.innerHTML = '';
  saleScanEl.value = '';
  updateRecentScansUI();
}
function previewAdd(code){
  const v = code || saleScanEl.value.trim();
  const p = products.find(p=>p.b && p.b.toString() === v) || findProductByKey(v);
  if(!p) return alert('Produkt nuk u gjet');
  addToSale(p);
  showPreview(v, p, true);
  saleScanEl.value = ''; saleScanEl.focus();
}

/* ======= PAYMENT & RECEIPTS ======= */
function pay(){
  try{
    const totalBefore = sales.reduce((s,i)=>s + (i.q * i.p), 0);
    const {discount, details} = calculatePromosForSale();
    const total = Math.max(0, totalBefore - discount);
    const cash = +paidEl.value || 0;
    if(sales.length === 0) { alert('Shporta √´sht√´ bosh'); return; }

    const clientName = (document.getElementById('client').value || '').trim();
    const changeAmount = Math.max(0, cash - total);
    const netCollected = Math.min(cash, total);
    const due = Math.max(0, total - cash);
    const status = cash >= total ? 'paid' : 'owed';

    for(const item of sales){
      const prod = products.find(p=>p.b === item.b);
      if(prod) prod.s = Math.max(0, prod.s - item.q);
    }
    localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products));
    renderProducts();

    const timestamp = nowISO();
    const record = {
      id: timestamp + '_' + Math.random().toString(36).slice(2,7),
      timestamp,
      client: clientName || null,
      items: JSON.parse(JSON.stringify(sales)),
      totalBefore,
      discount,
      total,
      amountPaid: netCollected,
      cashGiven: cash,
      change: changeAmount,
      due,
      status
    };

    salesHistory.unshift(record);
    localStorage.setItem(KEY_SALES_HISTORY, JSON.stringify(salesHistory));

    daily += netCollected;
    localStorage.setItem(KEY_DAILY, daily);

    // audit
    logAudit('sale', 'sale', {id:record.id, total:record.total, user:currentUser});

    lastSaleRecord = record; // for printing
    sales = []; cancel();

    updateDaily();
    renderHistory();
    updateFinance();
    initFinanceChart();

    const prodHtml = `<ul class="txn-list">${record.items.map(it=>`<li>${escapeHtml(it.n)} x${it.q} = ${it.q*it.p} ALL</li>`).join('')}</ul>`;
    const html = status==='paid'
      ? `<div style="color:green;font-weight:700;margin-bottom:6px">Transaksioni u mbyll me sukses</div>
         <div><b>Produkte:</b>${prodHtml}</div>
         <div class="txn-summary">Total: ${record.total} ALL</div>
         <div>Klienti dha: ${record.cashGiven} ALL</div>
         <div>Kusur: ${record.change} ALL</div>
         <div class="small" style="margin-top:6px">Shuma e shtuar n√´ ark√´ (neto): ${record.amountPaid} ALL</div>`
      : `<div style="color:#b45f00;font-weight:700;margin-bottom:6px">Shitja u regjistrua si BORXH</div>
         <div><b>Produkte:</b>${prodHtml}</div>
         <div class="txn-summary">Total: ${record.total} ALL</div>
         <div>Paguat tani (neto): ${record.amountPaid} ALL</div>
         <div>Mbetje (borxh): ${record.due} ALL</div>`;
    txnTitleEl.textContent = status==='paid' ? 'Shitje e plot√´' : 'Shitje me borxh';
    showTxn(html);
  }catch(err){
    console.error('Pay error:', err);
    alert('Gabim gjat√´ pages√´s. Shikoni console p√´r detaje.');
  }
}

function printCurrentReceipt(){
  const rec = lastSaleRecord;
  if(!rec) return alert('Nuk ka transaksion p√´r printim');
  const win = window.open('','_blank','width=400,height=600');
  const qr = encodeURIComponent(`sale:${rec.id};total:${rec.total};ts:${rec.timestamp}`);
  const qrUrl = `https://chart.googleapis.com/chart?chs=150x150&cht=qr&chl=${qr}`;
  let html = `<html><head><title>Receipt</title><style>body{font-family:Arial;padding:12px}h3{margin:0 0 8px 0}table{width:100%}</style></head><body>`;
  html += `<h3>POS Market</h3><div>${rec.timestamp.replace('T',' ').slice(0,19)}</div><hr>`;
  html += '<table>';
  rec.items.forEach(i=> html += `<tr><td>${escapeHtml(i.n)}</td><td style="text-align:right">${i.q} x ${i.p}</td></tr>`);
  html += `</table><hr><div><b>Total:</b> ${rec.total} ALL</div>`;
  if(rec.discount) html += `<div><small>Discount: ${rec.discount} ALL</small></div>`;
  html += `<div><small>Klient: ${escapeHtml(rec.client||'--')}</small></div>`;
  html += `<div style="margin-top:8px;"><img src="${qrUrl}" alt="QR"></div>`;
  html += `<div style="margin-top:12px"><button onclick="window.print()">Print</button></div>`;
  html += `</body></html>`;
  win.document.write(html);
  win.document.close();
}

/* ======= HISTORY & DEBT ======= */
function renderHistory(){
  histTableEl.innerHTML = '<tr><th>Data</th><th>Klient</th><th>Total</th><th>Paguar(net)</th><th>Mbetje</th><th>Status</th><th>Veprime</th></tr>';
  salesHistory.forEach(rec=>{
    histTableEl.innerHTML += `<tr>
      <td>${rec.timestamp.replace('T',' ').slice(0,19)}</td>
      <td>${escapeHtml(rec.client||'--')}</td>
      <td>${rec.total}</td>
      <td>${rec.amountPaid}</td>
      <td>${rec.due}</td>
      <td>${rec.status}</td>
      <td>
        <button onclick='viewSale("${rec.id}")'>Shiko</button>
        <button onclick='deleteSale("${rec.id}")'>üóëÔ∏è</button>
      </td>
    </tr>`;
  });
}
function viewSale(id){
  const r = salesHistory.find(x=>x.id===id);
  if(!r) return alert('Nuk u gjet shitja');
  const body = document.getElementById('viewBody');
  let html = `<p><b>Data:</b> ${r.timestamp.replace('T',' ').slice(0,19)}</p>`;
  html += `<p><b>Klient:</b> ${escapeHtml(r.client||'--')}</p>`;
  html += `<p><b>Total:</b> ${r.total} ALL</p>`;
  html += `<p><b>Paguar (neto):</b> ${r.amountPaid} ALL</p>`;
  html += `<p><b>Klienti dha:</b> ${r.cashGiven !== undefined ? r.cashGiven + ' ALL' : '--'}</p>`;
  html += `<p><b>Kusur:</b> ${r.change} ALL</p>`;
  html += `<p><b>Mbetje:</b> ${r.due} ALL</p>`;
  html += `<p><b>Status:</b> ${r.status}</p>`;
  html += '<hr><p><b>Produkte:</b></p><ul>';
  r.items.forEach(it=> html += `<li>${escapeHtml(it.n)} x${it.q} = ${it.q*it.p} ALL</li>`);
  html += '</ul>';
  body.innerHTML = html;
  document.getElementById('viewModal').dataset.currentId = id;
  document.getElementById('settleAmount').value = r.due || '';
  document.getElementById('viewModal').style.display='flex';
}
function closeView(){ document.getElementById('viewModal').style.display='none'; delete document.getElementById('viewModal').dataset.currentId; }
function deleteSale(id){
  if(!confirm('Fshi k√´t√´ regjistrim?')) return;
  const removed = salesHistory.filter(x=>x.id === id)[0];
  salesHistory = salesHistory.filter(x=>x.id !== id);
  localStorage.setItem(KEY_SALES_HISTORY, JSON.stringify(salesHistory));
  renderHistory(); updateFinance(); initFinanceChart();
  logAudit('delete_sale','sale',{id, removed, user:currentUser});
}

/* debt settle */
function settleDebt(){
  const id = document.getElementById('viewModal').dataset.currentId;
  if(!id) return alert('Nuk ka shitje t√´ zgjedhur');
  const r = salesHistory.find(x=>x.id===id);
  if(!r) return alert('Nuk u gjet shitja');
  const amt = +document.getElementById('settleAmount').value || 0;
  if(amt <= 0) return alert('Shuma duhet > 0');
  if(r.due <= 0) return alert('Nuk ka borxh');
  const payNow = Math.min(amt, r.due);
  r.amountPaid += payNow; r.due -= payNow;
  if(r.due <= 0){ r.status='paid'; r.due = 0; } else r.status='owed';
  daily += payNow; localStorage.setItem(KEY_DAILY, daily);
  localStorage.setItem(KEY_SALES_HISTORY, JSON.stringify(salesHistory));
  updateDaily(); renderHistory(); viewSale(id); updateFinance(); initFinanceChart();
  logAudit('settle_debt','sale',{id, payNow, user:currentUser});
  showTxn(`<div style="color:green;font-weight:700">Pagesa u regjistrua</div><div>U mbledh: ${payNow} ALL</div>`);
}

/* ======= BILANCI & SUGGESTIONS EVERY 2 DAYS ======= */
/* ... unchanged from previous but reuses audit logging where appropriate ... */
function getLocalDateStr(iso){ const d = new Date(iso); return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'); }
function isSameLocalDate(isoA, isoB){ return getLocalDateStr(isoA) === getLocalDateStr(isoB); }
function aggregateSales(records){ const agg = {}; records.forEach(r=>(r.items||[]).forEach(it=>{ const key = it.b || it.n; if(!agg[key]) agg[key] = {b: it.b, n: it.n, qty:0, revenue:0}; agg[key].qty += it.q; agg[key].revenue += (it.q * it.p); })); return agg; }
function getSalesSinceDays(days){ const cutoff = Date.now() - (days * 24 * 60 * 60 * 1000); return salesHistory.filter(r => new Date(r.timestamp).getTime() >= cutoff); }

function generateReorderReport_inner(){
  const last7 = getSalesSinceDays(7); const agg7 = aggregateSales(last7);
  const last14 = getSalesSinceDays(14); const agg14 = aggregateSales(last14);
  const suggestions = [], slowItems = [];
  products.forEach(p=>{
    const key = p.b || p.n; const sold7 = agg7[key] ? agg7[key].qty : 0; const avgDaily7 = sold7 / 7; const leadDaysFactor = 3; const targetStock = Math.ceil(avgDaily7 * leadDaysFactor);
    if(avgDaily7 > 0){
      if(p.s < targetStock){ const suggestedQty = Math.max(1, Math.ceil(avgDaily7 * 7) - p.s); suggestions.push({b:p.b,n:p.n,stock:p.s,avgDaily7:avgDaily7.toFixed(2),suggest: suggestedQty}); }
    } else { if(!agg14[key] || agg14[key].qty === 0) slowItems.push({b:p.b,n:p.n,stock:p.s}); }
  });
  return {suggestions, slowItems};
}

function closeDay(){
  const sys = daily;
  const arka = +cashRealEl.value || 0;
  const diffv = arka - sys;
  const closures = JSON.parse(localStorage.getItem(KEY_CLOSURES)||'[]');
  const closure = {timestamp:nowISO(), system:sys, cash:arka, diff:diffv, salesCount: salesHistory.length};
  closures.push(closure); localStorage.setItem(KEY_CLOSURES, JSON.stringify(closures));
  daily = 0; localStorage.setItem(KEY_DAILY, 0); cashRealEl.value=''; updateDaily(); diffEl.textContent = 0;

  // Show short closure report
  const now = new Date(); const todayStr = getLocalDateStr(now.toISOString());
  const todaySales = salesHistory.filter(r => isSameLocalDate(r.timestamp, now.toISOString()));
  const aggToday = aggregateSales(todaySales);
  let soldHtml='', totalQty=0, totalRev=0;
  if(Object.keys(aggToday).length === 0) soldHtml = '<div>Asnj√´ shitje sot.</div>';
  else { soldHtml = '<ul class="txn-list">'; Object.values(aggToday).forEach(item=>{ soldHtml += `<li>${escapeHtml(item.n)} ‚Äî Sasi: ${item.qty} ‚Äî T√´ ardhura: ${item.revenue} ALL</li>`; totalQty += item.qty; totalRev += item.revenue; }); soldHtml += '</ul>'; }
  let topSellerHtml = '<div>Nuk ka t√´ dh√´na p√´r top-seller.</div>'; const itemsArr = Object.values(aggToday); if(itemsArr.length){ itemsArr.sort((a,b)=>b.qty - a.qty); const top = itemsArr[0]; topSellerHtml = `<div class="suggestion"><b>Top Produkt i Sot√´m:</b> ${escapeHtml(top.n)} ‚Äî Sasi: ${top.qty} ‚Äî T√´ ardhura: ${top.revenue} ALL</div>`; }

  const html = `
    <div style="color:green;font-weight:700;margin-bottom:6px">Mbyllje dite</div>
    <div>Shuma n√´ sistem (duhet n√´ ark√´): ${closure.system} ALL</div>
    <div>Arka (me dore): ${closure.cash} ALL</div>
    <div style="margin-top:6px"><b>Diferenca:</b> ${closure.diff} ALL</div>
    <hr>
    <div><b>Raporti i Shitjeve p√´r sot (${todayStr}):</b></div>
    ${soldHtml}
    <div><b>Totali i produkteve te shitura:</b> ${totalQty} ‚Äî <b>T√´ ardhurat:</b> ${totalRev} ALL</div>
    ${topSellerHtml}
  `;
  txnTitleEl.textContent = 'Mbyllje dite'; showTxn(html);
  logAudit('close_day','closure',closure);

  // suggestions every 2 days: check last suggestion timestamp
  const lastSuggest = localStorage.getItem(KEY_LAST_SUGGEST);
  const nowMs = Date.now();
  const TWO_DAYS_MS = 2 * 24 * 60 * 60 * 1000;
  if(!lastSuggest || (nowMs - new Date(lastSuggest).getTime() >= TWO_DAYS_MS)){
    const rep = generateReorderReport_inner();
    let sHtml = `<div style="color:#0b5cff;font-weight:700;margin-bottom:6px">Sugjerime Riporositjeje (bazuar n√´ 7 dit√´)</div>`;
    if(rep.suggestions.length === 0) sHtml += '<div>Asnj√´ sugjerim p√´r riporositje bazuar n√´ 7-ditoren e fundit.</div>';
    else {
      sHtml += '<div><b>Sugjerime blerjeje:</b></div><ul class="txn-list">';
      rep.suggestions.forEach(s=> sHtml += `<li>${escapeHtml(s.n)} ‚Äî Stok aktual: ${s.stock} ‚Äî Mesatare/dit√´: ${s.avgDaily7} ‚Äî Shto rreth: <b>${s.suggest}</b></li>`);
      sHtml += '</ul>';
    }
    if(rep.slowItems.length){ sHtml += '<div style="margin-top:8px"><b>Produkte pa shitje n√´ 14 dit√´:</b></div><ul class="txn-list">'; rep.slowItems.forEach(si=> sHtml += `<li>${escapeHtml(si.n)} ‚Äî Stok: ${si.stock}</li>`); sHtml += '</ul>'; }
    suggestBodyEl.innerHTML = sHtml;
    suggestModalEl.style.display = 'flex';
    localStorage.setItem(KEY_LAST_SUGGEST, nowISO());
    logAudit('generate_suggestions','system',{count:rep.suggestions.length});
  } else {
    console.log('Sugjerimet jan√´ prodhuar s√´ fundi, do t√´ prodhohen p√´rs√´ri pas 2 dit√´sh.');
  }
}

/* ======= FINANCE (without incomes) ======= */
function computeRevenue(from=null,to=null){
  const fromD = from ? new Date(from) : null; const toD = to ? new Date(to) : null;
  let total = 0;
  salesHistory.forEach(s=>{
    const d = new Date(s.timestamp);
    if(fromD && d < fromD) return;
    if(toD && d > new Date(toD.getTime() + 24*3600*1000 -1)) return;
    total += Number(s.total) || 0;
  });
  return total;
}
function computeCOGS_from_stock(from=null,to=null){
  const fromD = from ? new Date(from) : null; const toD = to ? new Date(to) : null;
  let cogs = 0;
  salesHistory.forEach(s=>{
    const d = new Date(s.timestamp);
    if(fromD && d < fromD) return;
    if(toD && d > new Date(toD.getTime() + 24*3600*1000 -1)) return;
    s.items.forEach(it=>{
      const prod = products.find(p=>p.b === it.b);
      const unitCost = prod ? (Number(prod.purchase_price) || 0) : 0;
      cogs += unitCost * (Number(it.q) || 0);
    });
  });
  return Math.round(cogs);
}
function computeExpenses(from=null,to=null){
  const fromD = from ? new Date(from) : null; const toD = to ? new Date(to) : null;
  let total = 0;
  expenses.forEach(e=>{
    const d = new Date(e.date || e.ts || new Date().toISOString());
    if(fromD && d < fromD) return;
    if(toD && d > new Date(toD.getTime() + 24*3600*1000 -1)) return;
    total += Number(e.amount) || 0;
  });
  return Math.round(total);
}
function updateFinance(){
  const from = document.getElementById('finFrom').value || null;
  const to = document.getElementById('finTo').value || null;
  const revenue = computeRevenue(from,to);
  const cogs = computeCOGS_from_stock(from,to);
  const profitBefore = revenue - cogs;
  const expensesTotal = computeExpenses(from,to);
  const netProfit = profitBefore - expensesTotal; // no separate incomes
  const vat = revenue * (Number(vatRate) || 0) / 100;
  const margin = revenue > 0 ? ((profitBefore / revenue) * 100).toFixed(2) : '0.00';

  document.getElementById('finRevenue').innerText = revenue + ' ALL';
  document.getElementById('finCOGS').innerText = cogs + ' ALL';
  document.getElementById('finProfit').innerText = Math.round(profitBefore) + ' ALL';
  document.getElementById('finMargin').innerText = `Margin√´: ${margin}%`;
  document.getElementById('finExpenses').innerText = expensesTotal + ' ALL';
  document.getElementById('finNetProfit').innerText = Math.round(netProfit) + ' ALL';
  document.getElementById('finVAT').innerText = `TVSH e llogaritur: ${Math.round(vat)} ALL (rate ${vatRate || 0}%)`;

  updateFinanceChart(from,to);
  renderTopProducts(from,to);

  // dashboard KPI updates
  document.getElementById('kpiRev').innerText = computeRevenue(null, null) + ' ALL';
  const today = new Date().toISOString().slice(0,10);
  const todaySales = salesHistory.filter(s => s.timestamp.slice(0,10) === today).reduce((a,b)=>a + (b.amountPaid || b.total), 0);
  document.getElementById('kpiToday').innerText = Math.round(todaySales) + ' ALL';
  document.getElementById('kpiLow').innerText = products.filter(p=>p.s <= LOW_STOCK_THRESHOLD).length;
}

/* ======= Finance Chart & Dashboard chart ======= */
function initFinanceChart(){
  const canvas = document.getElementById('finChart');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  if(finChart){ finChart.destroy(); finChart = null; }
  finChart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [
      { label: 'T√´ ardhurat (ALL)', data: [], borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.12)', fill: true },
      { label: 'Fitim (ALL)', data: [], borderColor: '#16a34a', backgroundColor: 'rgba(16,163,74,0.12)', fill: true }
    ]},
    options: {
      responsive: true,
      scales: { x:{ title:{ display:true, text:'Dat√´' }}, y:{ title:{ display:true, text:'ALL' } } },
      plugins: { legend: { position:'top' } }
    }
  });
  updateFinance();
  initDashboardChart();
}

function updateFinanceChart(from=null,to=null){
  if(!finChart) initFinanceChart();
  let fromDate = from ? new Date(from) : null;
  let toDate = to ? new Date(to) : null;
  if(!fromDate || !toDate){ toDate = new Date(); fromDate = new Date(); fromDate.setDate(toDate.getDate() - 13); }
  if(fromDate > toDate){ const tmp = fromDate; fromDate = toDate; toDate = tmp; }
  const labels = [];
  const revMap = {}, profitMap = {};
  const dayCount = Math.round((toDate - fromDate) / (24*3600*1000)) + 1;
  for(let i=0;i<dayCount;i++){
    const d = new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate() + i);
    const key = d.toISOString().slice(0,10);
    labels.push(key); revMap[key] = 0; profitMap[key] = 0;
  }
  salesHistory.forEach(s=>{
    const day = s.timestamp.slice(0,10);
    if(!(day in revMap)) return;
    const revenue = Number(s.total) || 0;
    let cogs = 0;
    s.items.forEach(it=>{
      const prod = products.find(p=>p.b === it.b);
      const unitCost = prod ? (Number(prod.purchase_price) || 0) : 0;
      cogs += unitCost * (Number(it.q) || 0);
    });
    revMap[day] += revenue;
    profitMap[day] += (revenue - cogs);
  });
  const revData = labels.map(l=>revMap[l] || 0);
  const profitData = labels.map(l=>profitMap[l] || 0);
  finChart.data.labels = labels;
  finChart.data.datasets[0].data = revData;
  finChart.data.datasets[1].data = profitData;
  finChart.update();
}

let dashChart = null;
function initDashboardChart(){
  const canvas = document.getElementById('dashChart');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  if(dashChart){ dashChart.destroy(); dashChart = null; }
  dashChart = new Chart(ctx, { type:'bar', data:{labels:[],datasets:[{label:'Revenue',data:[],backgroundColor:'#2563eb'}]}, options:{responsive:true}});
  updateDashboardChart();
}
function updateDashboardChart(){
  if(!dashChart) return;
  const labels = [];
  const data = [];
  const days = 14;
  for(let i=days-1;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate()-i);
    const key = d.toISOString().slice(0,10);
    labels.push(key);
    const sum = salesHistory.filter(s=>s.timestamp.slice(0,10)===key).reduce((a,b)=>a + (b.amountPaid || b.total),0);
    data.push(sum);
  }
  dashChart.data.labels = labels;
  dashChart.data.datasets[0].data = data;
  dashChart.update();
  document.getElementById('kpiTop').innerText = getTopProductName();
}

/* ======= TOP PRODUCTS ======= */
function renderTopProducts(from=null,to=null){
  const fromD = from ? new Date(from) : null; const toD = to ? new Date(to) : null;
  const agg = {};
  salesHistory.forEach(s=>{
    const d = new Date(s.timestamp);
    if(fromD && d < fromD) return;
    if(toD && d > new Date(toD.getTime() + 24*3600*1000 -1)) return;
    s.items.forEach(it=>{
      const key = it.b || it.n;
      if(!agg[key]) agg[key] = {n: it.n, qty:0, revenue:0, cogs:0};
      agg[key].qty += it.q;
      agg[key].revenue += it.q * it.p;
      const prod = products.find(p=>p.b === it.b);
      const unitCost = prod ? (Number(prod.purchase_price) || 0) : 0;
      agg[key].cogs += unitCost * it.q;
    });
  });
  const arr = Object.values(agg);
  arr.sort((a,b)=>b.revenue - a.revenue);
  let html = '<table class="small-table"><tr><th>Produkt</th><th>Sasi</th><th>T√´ ardhura</th><th>Fitim</th></tr>';
  arr.slice(0,10).forEach(r=> html += `<tr><td>${escapeHtml(r.n)}</td><td>${r.qty}</td><td>${r.revenue}</td><td>${Math.round(r.revenue - r.cogs)}</td></tr>`);
  html += '</table>';
  if(arr.length === 0) html = '<div class="small">Asnj√´ aktivitet p√´r periudh√´n e zgjedhur.</div>';
  topProductsEl.innerHTML = html;
}
function getTopProductName(){
  const agg = {};
  salesHistory.forEach(s => s.items.forEach(it => {
    const key = it.b || it.n;
    if(!agg[key]) agg[key] = {n:it.n, qty:0};
    agg[key].qty += it.q;
  }));
  const arr = Object.values(agg).sort((a,b)=>b.qty - a.qty);
  return arr.length ? `${arr[0].n} (${arr[0].qty})` : '--';
}

/* ======= EXPENSES MANAGEMENT ======= */
function addExpense(){
  const desc = (document.getElementById('expDesc').value || '').trim();
  const amount = Number(document.getElementById('expAmount').value) || 0;
  const date = document.getElementById('expDate').value || nowISO();
  const category = document.getElementById('expCategory').value || 'other';
  if(!desc) return alert('Vendos p√´rshkrim t√´ shpenzimit');
  if(amount <= 0) return alert('Shuma duhet > 0');
  const rec = { id: nowISO() + '_' + Math.random().toString(36).slice(2,6), desc, amount, date, category };
  expenses.unshift(rec);
  localStorage.setItem(KEY_EXPENSES, JSON.stringify(expenses));
  document.getElementById('expDesc').value=''; document.getElementById('expAmount').value=''; document.getElementById('expDate').value='';
  renderExpenses();
  updateFinance();
  logAudit('add_expense','expense',rec);
}
function renderExpenses(){
  if(!expenses.length){ expensesListEl.innerHTML = '<div class="small">Nuk ka shpenzime t√´ regjistruara.</div>'; return; }
  let html = '<div>';
  expenses.slice(0,200).forEach(e => {
    html += `<div class="expense-row"><div><b>${escapeHtml(e.desc)}</b><div class="small">${(e.date||'').slice(0,10)} ‚Ä¢ ${escapeHtml(e.category)}</div></div><div>${e.amount} ALL <button onclick="deleteExpense('${e.id}')">üóëÔ∏è</button></div></div>`;
  });
  html += '</div>';
  expensesListEl.innerHTML = html;
}
function deleteExpense(id){
  if(!confirm('Fshi k√´t√´ shpenzim?')) return;
  const removed = expenses.filter(e=>e.id===id)[0];
  expenses = expenses.filter(e=>e.id !== id);
  localStorage.setItem(KEY_EXPENSES, JSON.stringify(expenses));
  renderExpenses();
  updateFinance();
  logAudit('delete_expense','expense',{id, removed});
}

/* ======= RENT / DEBT PLAN ======= */
function saveRentDebt(){
  rentMonthly = Number(document.getElementById('rentMonthly').value) || 0;
  debtTotal = Number(document.getElementById('debtTotal').value) || 0;
  debtDueDays = Number(document.getElementById('debtDueDays').value) || 30;
  localStorage.setItem(KEY_RENT, rentMonthly);
  localStorage.setItem(KEY_DEBT, debtTotal);
  localStorage.setItem(KEY_DEBT_DAYS, debtDueDays);
  alert('Ruajtja u krye');
  computeSavingsPlan();
  logAudit('save_rent_debt','settings',{rentMonthly,debtTotal, debtDueDays, user:currentUser});
}
function computeSavingsPlan(){
  const closures = JSON.parse(localStorage.getItem(KEY_CLOSURES) || '[]');
  let dailySales = 0;
  if(closures.length){
    dailySales = Number(closures[closures.length-1].system || 0);
  } else {
    const map = {};
    salesHistory.forEach(s => {
      const day = s.timestamp.slice(0,10);
      map[day] = (map[day] || 0) + (Number(s.amountPaid || s.total) || 0);
    });
    const vals = Object.values(map).slice(-7);
    const sum = vals.reduce((a,b)=>a+b,0);
    dailySales = vals.length ? sum / vals.length : 0;
  }

  const daysInMonth = (new Date()).getDate() > 0 ? new Date((new Date()).getFullYear(), (new Date()).getMonth()+1, 0).getDate() : 30;
  const rentDaily = rentMonthly > 0 ? (rentMonthly / daysInMonth) : 0;
  const debtDaily = debtTotal > 0 ? (debtTotal / (debtDueDays || 1)) : 0;
  const saveDaily = Math.round((rentDaily + debtDaily) * 100) / 100;
  const percentOfDailySales = dailySales > 0 ? Math.round((saveDaily / dailySales) * 10000) / 100 : null;
  const daysToSaveAtCurrent = saveDaily > 0 ? Math.round((rentMonthly + debtTotal) / saveDaily) : null;

  let html = `<div><b>Referenca (shitje ditore):</b> ${Math.round(dailySales)} ALL</div>`;
  html += `<div><b>Qira mujore:</b> ${rentMonthly} ALL ‚Äî <b>Qira/dit√´:</b> ${Math.round(rentDaily*100)/100} ALL</div>`;
  html += `<div><b>Borxh total:</b> ${debtTotal} ALL ‚Äî <b>Shlyerje brenda:</b> ${debtDueDays} dit√´ ‚Äî <b>Borxh/dit√´:</b> ${Math.round(debtDaily*100)/100} ALL</div>`;
  html += `<hr><div><b>Duhet t√´ kursosh/dit√´:</b> <span style="font-weight:700">${saveDaily} ALL</span></div>`;
  if(percentOfDailySales !== null) html += `<div class="small">Kjo √´sht√´ rreth <b>${percentOfDailySales}%</b> e shitjeve ditore (referenc√´)</div>`;
  if(daysToSaveAtCurrent !== null) html += `<div class="small">Me k√´t√´ kursim, do t√´ nevojiten rreth <b>${daysToSaveAtCurrent}</b> dit√´ p√´r t√´ mbledhur qiran√´ + borxhin nj√´her√´sh</div>`;

  savingsResultEl.innerHTML = html;
  const plan = { ts: nowISO(), refDaily: Math.round(dailySales), rentMonthly, debtTotal, debtDueDays, saveDaily, percentOfDailySales, daysToSaveAtCurrent };
  localStorage.setItem(KEY_LAST_PLAN, JSON.stringify(plan));
  logAudit('compute_savings','planning', plan);
  return plan;
}

/* ======= MONTHLY REPORT (sales vs purchases vs rent/borxh) ======= */
function exportMonthlyReportXLSX(){
  const val = document.getElementById('reportMonth').value;
  if(!val) return alert('Zgjidh muaj (YYYY-MM)');
  const [y,m] = val.split('-').map(Number);
  const from = new Date(y, m-1, 1);
  const to = new Date(y, m, 0,23,59,59);
  const fromISO = from.toISOString(); const toISO = to.toISOString();
  const salesInMonth = salesHistory.filter(s => s.timestamp >= fromISO && s.timestamp <= toISO);
  const totalSales = salesInMonth.reduce((a,b)=>a + (b.total||0), 0);
  // purchases approximated by sum of sold qty * purchase_price
  let purchases = 0;
  salesInMonth.forEach(s => s.items.forEach(it => {
    const prod = products.find(p=>p.b===it.b);
    const cost = prod ? Number(prod.purchase_price) || 0 : 0;
    purchases += cost * it.q;
  }));
  const rent = rentMonthly || 0;
  const debt = debtTotal || 0;

  const summary = [
    {metric:'month', value:val},
    {metric:'total_sales', value:totalSales},
    {metric:'total_purchases_estimated', value:Math.round(purchases)},
    {metric:'rent_monthly', value:rent},
    {metric:'debt_total', value:debt},
    {metric:'net', value: Math.round(totalSales - purchases - rent)}
  ];

  const salesRows = salesInMonth.map(s => ({id:s.id, ts:s.timestamp, total:s.total, paid:s.amountPaid, due:s.due}));

  saveXLSX({Summary:summary, Sales:salesRows}, `monthly_report_${val}.xlsx`);
  logAudit('export_monthly_report','report',{month:val, user:currentUser});
}

/* ======= SYNC (simple stub) ======= */
async function syncNow(){
  const url = document.getElementById('syncUrl').value.trim();
  if(!url) return alert('Vendos URL t√´ backend p√´r sync');
  const payload = { products, salesHistory, expenses, promos: promotions, closures: JSON.parse(localStorage.getItem(KEY_CLOSURES)||'[]') };
  try{
    const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const json = await r.json();
    // backend can return merged data - naive merge:
    if(json && json.merged){
      // example: merge products (by barcode), sales, expenses...
      // Here we simply notify user ‚Äî real merging needs server-side logic
      document.getElementById('syncResult').innerText = 'Sync sukses: server returned merged=true';
      logAudit('sync','sync',{url, status:'ok', user:currentUser});
    } else {
      document.getElementById('syncResult').innerText = 'Sync completed (server response).';
      logAudit('sync','sync',{url, status:'ok', user:currentUser});
    }
  }catch(err){
    document.getElementById('syncResult').innerText = 'Sync error: ' + err.message;
    logAudit('sync_error','sync',{url, err:err.message, user:currentUser});
  }
}

/* ======= STOCK TAKE (inventory adjustments) ======= */
function openStockTake(){
  const listEl = document.getElementById('stockTakeList');
  let html = '<table class="small-table"><tr><th>Produkt</th><th>Current</th><th>Counted</th></tr>';
  products.forEach((p,i) => html += `<tr><td>${escapeHtml(p.n)}</td><td>${p.s}</td><td><input id="stock_in_${i}" type="number" value="${p.s}" style="width:120px"></td></tr>`);
  html += '</table>';
  listEl.innerHTML = html;
  document.getElementById('stockModal').style.display = 'flex';
}
function closeStockTake(){ document.getElementById('stockModal').style.display = 'none'; }
function confirmStockTake(){
  if(!confirm('P√´rdit√´so stokun me sasit√´ e futura?')) return;
  products.forEach((p,i) => {
    const v = Number(document.getElementById('stock_in_'+i).value) || 0;
    const old = p.s;
    p.s = v;
    logAudit('stock_take_adjust','product',{barcode:p.b, old, new:v, user:currentUser});
  });
  localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products));
  renderProducts();
  closeStockTake();
  alert('Stoku u p√´rdit√´sua');
}

/* ======= SCANNER HID DETECTION (simple buffer timing) ======= */
let scannerBuffer = '';
let scannerLastTime = 0;
document.addEventListener('keydown', (e) => {
  if(!document.getElementById('scannerMode').checked) return; // only active if enabled
  const now = Date.now();
  const elapsed = now - scannerLastTime;
  scannerLastTime = now;
  if(elapsed < (scannerSettings.threshold || 50)){
    // fast typing -> likely scanner; accumulate char
    if(e.key.length === 1) scannerBuffer += e.key;
    if(e.key === 'Enter'){
      const code = scannerBuffer.trim();
      scannerBuffer = '';
      if(code){
        saleScanEl.value = code;
        saleScanEl.dispatchEvent(new KeyboardEvent('keydown', {key:'Enter'}));
      }
    }
  } else {
    // normal typing; reset buffer
    scannerBuffer = '';
  }
});

/* ======= STORAGE SYNC ACROSS TABS ======= */
window.addEventListener('storage', (e)=>{
  if(e.key === KEY_PRODUCTS){ products = JSON.parse(e.newValue || '[]'); renderProducts(); initFinanceChart(); }
  if(e.key === KEY_SALES_HISTORY){ salesHistory = JSON.parse(e.newValue || '[]'); renderHistory(); updateFinance(); initFinanceChart(); }
  if(e.key === KEY_DAILY){ daily = +e.newValue || 0; updateDaily(); }
  if(e.key === KEY_RECENT_SCANS){ recentScans = JSON.parse(e.newValue || '[]'); updateRecentScansUI(); }
  if(e.key === KEY_EXPENSES){ expenses = JSON.parse(e.newValue || '[]'); renderExpenses(); updateFinance(); }
  if(e.key === KEY_VAT){ vatRate = Number(e.newValue || 0); if(vatRateEl) vatRateEl.value = vatRate; updateFinance(); }
  if(e.key === KEY_PROMOS){ promotions = JSON.parse(e.newValue || '[]'); renderPromos(); }
  if(e.key === KEY_AUDIT){ /* re-render if audit open */ }
});

/* ======= LOGIN & INIT ======= */
function doLogin(){
  const fu = document.getElementById('u').value.trim();
  const fp = document.getElementById('p').value;
  const f = users.find(x=>x.u===fu && x.p===fp);
  if(!f){ document.getElementById('msg').textContent = 'Gabim login'; return; }
  currentUser = fu;
  role = f.r;
  document.getElementById('loginSec').style.display = 'none';
  document.getElementById('menu').style.display = 'block';
  document.querySelectorAll('.admin').forEach(e=>e.style.display = role === 'admin' ? 'inline-block' : 'none');
  openSec('dash');
  renderProducts(); renderHistory(); updateDaily(); initFinanceChart();
  renderExpenses(); renderPromos();
  vatRateEl.value = vatRate;
  document.getElementById('rentMonthly').value = rentMonthly || '';
  document.getElementById('debtTotal').value = debtTotal || '';
  document.getElementById('debtDueDays').value = debtDueDays || 30;
  logAudit('login','user',{user:currentUser});
}
function logout(){ logAudit('logout','user',{user:currentUser}); location.reload(); }

/* ======= INIT UI on load ======= */
document.getElementById('u').value = 'admin'; document.getElementById('p').value = 'admin';
renderProducts(); renderHistory(); updateDaily(); initFinanceChart();
recentScans = JSON.parse(localStorage.getItem(KEY_RECENT_SCANS) || '[]');
updateRecentScansUI();
expenses = JSON.parse(localStorage.getItem(KEY_EXPENSES) || '[]');
renderExpenses();
promotions = JSON.parse(localStorage.getItem(KEY_PROMOS) || '[]');
renderPromos();
vatRate = Number(localStorage.getItem(KEY_VAT) || 0);
if(vatRateEl) vatRateEl.value = vatRate;

/* Device time display */
function updateDeviceTimeDisplays(){
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const ss = String(now.getSeconds()).padStart(2,'0');
  deviceTimeEl.textContent = `${hh}:${mm}:${ss}`;
  finDeviceTimeEl.textContent = `${hh}:${mm}:${ss}`;
}
setInterval(updateDeviceTimeDisplays, 1000);
updateDeviceTimeDisplays();

/* Live preview while typing */
saleScanEl.addEventListener('input', ()=> {
  const v = saleScanEl.value.trim();
  if(!v){ clearPreview(); return; }
  const found = products.find(p => p.b && p.b.toString() === v) || findProductByKey(v);
  showPreview(v, found || null, false);
});

/* Bilanci: diff updates live when cashReal changes */
cashRealEl && cashRealEl.addEventListener('input', ()=> {
  const arka = +cashRealEl.value || 0;
  diffEl.textContent = (arka - daily);
});

/* Finance date inputs trigger refresh */
document.getElementById('finFrom').addEventListener('change', ()=> updateFinance());
document.getElementById('finTo').addEventListener('change', ()=> updateFinance());

/* Simple helpers for XLSX exports used in UI */
function exportSalesXLSX(){ exportSalesXLSX; } // placeholder to keep UI buttons consistent (real functions above)

/* ======= Stock Take: close handlers are defined above ======= */

</script>

<!-- Register service worker for PWA (simple) -->
<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(err => console.warn('SW register failed', err));
}
</script>
</body>
</html>
