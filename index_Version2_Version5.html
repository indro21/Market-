<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="UTF-8">
<title>POS Market ‚Äì Finance (Sugjerime 2-ditore)</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
body{margin:0;font-family:Segoe UI,Arial,Helvetica;background:#eef2f7}
header{background:#1e293b;color:#fff;padding:15px;display:flex;align-items:center;justify-content:space-between;gap:12px}
nav button{margin:4px;padding:10px;border:none;border-radius:10px;background:#334155;color:#fff;cursor:pointer}
section{display:none;padding:15px}
section.active{display:block}
.card{background:#fff;padding:15px;border-radius:14px;margin-bottom:12px;box-shadow:0 8px 18px rgba(0,0,0,.1)}
input,button,select{padding:8px;border-radius:8px;border:1px solid #cbd5f5}
button{background:#2563eb;color:#fff;font-weight:600;margin:3px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:6px;border-bottom:1px solid #e5e7eb;text-align:center}
th{background:#f1f5f9}
.admin{display:none}
.qtyBtn{padding:4px 8px}
.small{font-size:0.9em;color:#374151}
.kv{font-weight:600}
.row{display:flex;gap:8px;flex-wrap:wrap}
.col{flex:1;min-width:120px}

/* FINANCE specific */
.finance-top{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.finance-metrics{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
.finance-metrics .box{background:#f8fafc;padding:10px;border-radius:8px;min-width:150px}
#deviceTime{font-size:0.95em;color:#dbeafe}
canvas{max-width:100%;height:320px;display:block}

/* Sale preview */
.scan-preview{margin-top:8px;padding:12px;background:#fff;border-radius:8px;border:1px solid #e6eefc;box-shadow:0 4px 12px rgba(2,6,23,0.03)}
.scan-preview h4{margin:0 0 6px 0}
.preview-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.preview-col{flex:1;min-width:140px}
.preview-actions{margin-top:8px;text-align:right}
.preview-added{color:green;font-weight:700}
.preview-missing{color:#b45f00;font-weight:700}
.recent-scans{margin-top:8px;font-size:0.9em;color:#374151}

/* basic modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:999;align-items:center;justify-content:center}
.modal-content{background:#fff;margin:20px auto;padding:15px;width:95%;max-width:720px;border-radius:12px}
.small-modal .modal-content{max-width:520px}
.txn-list{margin:6px 0;padding-left:18px}
.txn-summary{margin-top:8px;font-weight:600}
.suggestion{background:#f8fafc;padding:8px;border-radius:8px;margin-top:6px}

/* LOW STOCK highlight */
.low-stock-row{background:linear-gradient(90deg, rgba(254,226,226,0.9), rgba(255,250,250,0.6)); border-left:6px solid #ef4444;}
.low-stock-badge{display:inline-block;background:#ef4444;color:#fff;padding:4px 8px;border-radius:999px;font-weight:700;margin-left:8px;font-size:0.85em}
.low-stock-top{margin-bottom:8px;color:#7f1d1d;font-weight:700}

/* expenses list */
.expense-row{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px solid #eee}

/* small tables in finance */
.small-table{width:100%;border-collapse:collapse}
.small-table th, .small-table td{padding:6px;border:1px solid #eee;text-align:left}
</style>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header>
  <div style="display:flex;gap:12px;align-items:center">
    <h2 style="margin:0">üõí POS Market</h2>
    <div id="deviceTime">--:--:--</div>
  </div>

  <nav id="menu" style="display:none">
    <button onclick="openSec('prod')" class="admin">Stok</button>
    <button onclick="openSec('sale')">Shitje</button>
    <button onclick="openSec('bil')" class="admin">Bilanc</button>
    <button onclick="openSec('hist')">Historik</button>
    <button onclick="openSec('fin')" class="admin">Financa</button>
    <button onclick="logout()">Dil</button>
  </nav>
</header>

<!-- LOGIN -->
<section id="loginSec" class="active">
<div class="card">
<h3>Login</h3>
<input id="u" placeholder="User">
<input id="p" type="password">
<button onclick="doLogin()">Hyr</button>
<p id="msg" style="color:red"></p>
</div>
</section>

<!-- STOK -->
<section id="prod">
<div class="card admin">
<h3>Shto Produkt</h3>
<div class="row">
<input id="pn" placeholder="Emri" class="col">
<input id="pb" placeholder="Barkodi (unik)" class="col">
</div>
<div class="row" style="margin-top:8px">
<input id="pp" type="number" placeholder="√ámimi Shitje (ALL)" class="col">
<input id="pcost" type="number" placeholder="√ámimi Blerje (ALL)" class="col">
<input id="ps" type="number" placeholder="Sasia" class="col">
</div>
<div style="margin-top:8px">
<button onclick="addProduct()">‚ûï Shto</button>
<button onclick="exportProductsCSV()">‚¨áÔ∏è Eksporto Produkte (Excel/CSV)</button>
</div>
</div>
<div id="lowStockNotice" class="low-stock-top" style="display:none"></div>
<table id="prodTable"></table>
</section>

<!-- SHITJE -->
<section id="sale">
<div class="card" id="saleTopCard">
<div class="row">
<input id="saleScan" placeholder="Em√´r / Barkod / Scan USB" autofocus class="col">
<input id="client" placeholder="Emri i klientit (opsional)" class="col">
</div>
<div style="margin-top:8px">
<button onclick="manualAdd()">‚ûï Shto</button>
</div>

<div id="scanPreview" class="scan-preview">
  <h4>Preview skanimi</h4>
  <div id="previewContent" class="preview-row">
    <div class="preview-col">Kodi: <b id="previewCode">--</b></div>
    <div class="preview-col">Produkt: <b id="previewName">--</b></div>
    <div class="preview-col">√ámim: <b id="previewPrice">--</b></div>
    <div class="preview-col">Stok: <b id="previewStock">--</b></div>
  </div>
  <div class="preview-actions" id="previewActions"></div>
  <div class="recent-scans" id="recentScans">Skanime t√´ fundit: --</div>
</div>
</div>

<div class="card">
<table id="saleTable"></table>
<h3>Total: <span id="tot">0</span> ALL</h3>
<input id="paid" type="number" placeholder="Lek√´ nga klienti">
<h3>Kusur / Munges√´: <span id="change">0</span></h3>
<button onclick="pay()">Paguaj</button>
<button onclick="cancel()">Anulo</button>
</div>
</section>

<!-- BILANC -->
<section id="bil" class="admin">
<div class="card">
<h3>Bilanci Ditor</h3>
<p>Sistemi: <b><span id="daily">0</span> ALL</b></p>
<p class="small">(Kjo √´sht√´ shuma e parave t√´ ark√´tuara gjat√´ dit√´s)</p>
<input id="cashReal" type="number" placeholder="Shuma reale n√´ ark√´">
<p>Diferenca: <b><span id="diff">0</span></b></p>
<div style="margin-top:8px">
<button onclick="closeDay()">Mbyll Dit√´n</button>
<button onclick="exportClosuresCSV()">‚¨áÔ∏è Eksporto Mbylljet</button>
</div>
</div>
</section>

<!-- HISTORIK -->
<section id="hist">
<div class="card">
<h3>Historiku i Shitjeve</h3>
<div style="margin-bottom:8px">
<button onclick="exportCSV()">‚¨áÔ∏è Eksporto CSV</button>
<button onclick="clearOld()">üßπ Fshi t√´ gjitha (lokal)</button>
</div>
<table id="histTable"></table>
</div>
</section>

<!-- FINANCE (without incomes section) -->
<section id="fin" class="admin">
  <div class="card">
    <h3>FINANCA ‚Äî Raport & Instrumente</h3>

    <div class="finance-top">
      <div>
        <label class="small">Nga</label><br>
        <input id="finFrom" type="date">
      </div>
      <div>
        <label class="small">Deri</label><br>
        <input id="finTo" type="date">
      </div>
      <div style="margin-left:auto">
        <label class="small">Ora pajisjes</label><br>
        <div id="finDeviceTime" class="small">--:--:--</div>
      </div>
      <div><br><button onclick="updateFinance()">P√´rdit√´so Raport</button></div>
    </div>

    <div class="finance-metrics">
      <div class="box">
        <div class="small">T√´ ardhurat (shitjet)</div>
        <div id="finRevenue" class="kv">0 ALL</div>
      </div>
      <div class="box">
        <div class="small">COGS (nga blerja)</div>
        <div id="finCOGS" class="kv">0 ALL</div>
      </div>
      <div class="box">
        <div class="small">Fitim Bruto</div>
        <div id="finProfit" class="kv">0 ALL</div>
        <div id="finMargin" class="small">Margin√´: 0%</div>
      </div>
      <div class="box">
        <div class="small">Shpenzime (gjithsej)</div>
        <div id="finExpenses" class="kv">0 ALL</div>
      </div>
      <div class="box">
        <div class="small">Fitim Neto</div>
        <div id="finNetProfit" class="kv">0 ALL</div>
      </div>
      <div class="box">
        <div class="small">TVSH (%)</div>
        <div><input id="vatRate" type="number" style="width:80px" min="0" step="0.1"></div>
        <div id="finVAT" class="small">TVSH: 0 ALL</div>
      </div>
    </div>

    <div style="margin-top:12px">
      <h4>Grafik: T√´ ardhurat vs Fitimi (per periudh√´)</h4>
      <canvas id="finChart"></canvas>
    </div>

    <hr>

    <div style="margin-top:12px">
      <h4>Menaxho Shpenzime</h4>
      <div class="row">
        <input id="expDesc" placeholder="P√´rshkrim" class="col">
        <input id="expAmount" type="number" placeholder="Shuma (ALL)">
        <select id="expCategory">
          <option value="other">Other</option>
          <option value="salary">Salary</option>
          <option value="tax">Tax</option>
        </select>
        <input id="expDate" type="date">
        <button onclick="addExpense()">‚ûï Regjistro Shpenzim</button>
      </div>
      <div style="margin-top:8px">
        <button onclick="exportExpensesCSV()">‚¨áÔ∏è Eksporto Shpenzime (CSV)</button>
      </div>
      <div id="expensesList" style="margin-top:8px"></div>
    </div>

    <hr>

    <div style="margin-top:12px">
      <h4>Plan p√´r Qira & Borxhe</h4>
      <div class="row">
        <input id="rentMonthly" type="number" placeholder="Qira mujore (ALL)" class="col">
        <input id="debtTotal" type="number" placeholder="Borxhi total (ALL)" class="col">
        <input id="debtDueDays" type="number" placeholder="Dit√´ p√´r ta shlyer (p.sh.30)" class="col">
        <button onclick="saveRentDebt()">Ruaj</button>
      </div>
      <div style="margin-top:8px">
        <button onclick="computeSavingsPlan()">Llogarit sa t√´ kursosh</button>
        <button onclick="exportSavingsCSV()">‚¨áÔ∏è Eksporto Planin (CSV)</button>
      </div>
      <div id="savingsResult" style="margin-top:10px"></div>
    </div>

    <hr>

    <div style="margin-top:12px">
      <h4>Analiz√´ ‚Äî Top Produkte (periudha)</h4>
      <div id="topProducts"></div>
    </div>

  </div>
</section>

<!-- SUGGESTIONS MODAL (shown every 2 days when closing) -->
<div class="modal" id="suggestModal" style="display:none">
  <div class="modal-content">
    <h3>Sugjerime Riporositjeje (Automatik, √ßdo 2 dit√´)</h3>
    <div id="suggestBody"></div>
    <div style="margin-top:12px;text-align:right">
      <button onclick="closeSuggest()">Mbyll</button>
    </div>
  </div>
</div>

<!-- VIEW / PAY DEBT MODAL -->
<div class="modal" id="viewModal" style="display:none">
<div class="modal-content" id="viewContent">
<h3>Detajet e Shitjes</h3>
<div id="viewBody"></div>
<div style="margin-top:12px">
<input id="settleAmount" type="number" placeholder="Shuma p√´r t√´ shlyer (ALL)">
<button onclick="settleDebt()">Shlyej Borxh</button>
<button onclick="closeView()">Mbyll</button>
</div>
</div>
</div>

<!-- TRANSACTION SUCCESS MODAL (small) -->
<div class="modal" id="txnModal" style="display:none">
<div class="modal-content small-modal">
<h4 id="txnTitle">Transaksioni</h4>
<div id="txnMsg" class="small"></div>
<div style="margin-top:12px;text-align:right">
<button onclick="closeTxn()">Mbyll</button>
</div>
</div>
</div>

<script>
/* ======= CONFIG & STORAGE KEYS ======= */
const KEY_PRODUCTS = 'p';
const KEY_SALES_HISTORY = 'salesHistory';
const KEY_DAILY = 'daily';
const KEY_RECENT_SCANS = 'recentScans';
const KEY_EXPENSES = 'expenses';
const KEY_VAT = 'vatRate';
const KEY_CLOSURES = 'dayClosures';
const KEY_RENT = 'rentMonthly';
const KEY_DEBT = 'debtTotal';
const KEY_DEBT_DAYS = 'debtDueDays';
const KEY_LAST_SUGGEST = 'lastSuggestTS';

/* ======= STATE ======= */
const users=[{u:'admin',p:'admin',r:'admin'},{u:'kasier',p:'kasier',r:'kasier'}];
let role=null;
let products = JSON.parse(localStorage.getItem(KEY_PRODUCTS) || '[]');
let sales = [];
let salesHistory = JSON.parse(localStorage.getItem(KEY_SALES_HISTORY) || '[]');
let daily = +localStorage.getItem(KEY_DAILY) || 0;
let finChart = null;
let expenses = JSON.parse(localStorage.getItem(KEY_EXPENSES) || '[]');
let vatRate = Number(localStorage.getItem(KEY_VAT) || 0);

/* rent/debt settings */
let rentMonthly = Number(localStorage.getItem(KEY_RENT) || 0);
let debtTotal = Number(localStorage.getItem(KEY_DEBT) || 0);
let debtDueDays = Number(localStorage.getItem(KEY_DEBT_DAYS) || 30);

/* LOW STOCK threshold */
const LOW_STOCK_THRESHOLD = 1;

/* ======= ELEMENTS ======= */
const deviceTimeEl = document.getElementById('deviceTime');
const finDeviceTimeEl = document.getElementById('finDeviceTime');
const saleScanEl = document.getElementById('saleScan');
const paidEl = document.getElementById('paid');
const totEl = document.getElementById('tot');
const changeEl = document.getElementById('change');
const prodTableEl = document.getElementById('prodTable');
const saleTableEl = document.getElementById('saleTable');
const histTableEl = document.getElementById('histTable');
const dailyEl = document.getElementById('daily');
const cashRealEl = document.getElementById('cashReal');
const diffEl = document.getElementById('diff');
const txnModalEl = document.getElementById('txnModal');
const txnMsgEl = document.getElementById('txnMsg');
const txnTitleEl = document.getElementById('txnTitle');
const previewCodeEl = document.getElementById('previewCode');
const previewNameEl = document.getElementById('previewName');
const previewPriceEl = document.getElementById('previewPrice');
const previewStockEl = document.getElementById('previewStock');
const previewActionsEl = document.getElementById('previewActions');
const recentScansEl = document.getElementById('recentScans');
const lowStockNoticeEl = document.getElementById('lowStockNotice');
const vatRateEl = document.getElementById('vatRate');
const expensesListEl = document.getElementById('expensesList');
const topProductsEl = document.getElementById('topProducts');
const savingsResultEl = document.getElementById('savingsResult');
const suggestModalEl = document.getElementById('suggestModal');
const suggestBodyEl = document.getElementById('suggestBody');

/* ======= LOGIN ======= */
function doLogin(){
  const fu = document.getElementById('u').value.trim();
  const fp = document.getElementById('p').value;
  const f = users.find(x=>x.u===fu && x.p===fp);
  if(!f){ document.getElementById('msg').textContent = 'Gabim login'; return; }
  role = f.r;
  document.getElementById('loginSec').style.display = 'none';
  document.getElementById('menu').style.display = 'block';
  document.querySelectorAll('.admin').forEach(e=>e.style.display = role === 'admin' ? 'block' : 'none');
  openSec('sale');
  renderProducts();
  renderHistory();
  updateDaily();
  initFinanceChart();
  renderExpenses();
  vatRateEl.value = vatRate;
  document.getElementById('rentMonthly').value = rentMonthly || '';
  document.getElementById('debtTotal').value = debtTotal || '';
  document.getElementById('debtDueDays').value = debtDueDays || 30;
}
function logout(){ location.reload(); }
function openSec(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* ======= PRODUCTS ======= */
function renderProducts(){
  const low = [], normal = [];
  products.forEach(p => { if(Number(p.s) <= LOW_STOCK_THRESHOLD) low.push(p); else normal.push(p); });
  const ordered = low.concat(normal);

  prodTableEl.innerHTML = '<tr><th>Em√´r</th><th>Barkod</th><th>√ámim Shitje</th><th>√ámimi Blerje</th><th>Stok</th><th>Veprime</th></tr>';
  ordered.forEach((p,i)=>{
    const origIndex = products.indexOf(p);
    const lowClass = Number(p.s) <= LOW_STOCK_THRESHOLD ? 'low-stock-row' : '';
    prodTableEl.innerHTML += `
      <tr class="${lowClass}">
        <td><input value="${escapeHtml(p.n || '')}" onchange="products[${origIndex}].n=this.value;storeProducts()"></td>
        <td><input value="${escapeHtml(p.b || '')}" onchange="products[${origIndex}].b=this.value;storeProducts()"></td>
        <td><input type="number" value="${p.p || 0}" onchange="products[${origIndex}].p=+this.value;storeProducts()"></td>
        <td><input type="number" value="${p.purchase_price || 0}" onchange="products[${origIndex}].purchase_price=+this.value;storeProducts()"></td>
        <td><input type="number" value="${p.s || 0}" onchange="products[${origIndex}].s=+this.value;storeProducts()"></td>
        <td><button onclick="deleteProduct(${origIndex})">üóëÔ∏è</button></td>
      </tr>`;
  });

  const lowCount = products.filter(p => Number(p.s) <= LOW_STOCK_THRESHOLD).length;
  if(lowCount > 0){
    lowStockNoticeEl.style.display = 'block';
    lowStockNoticeEl.innerHTML = `Produkte me stok t√´ ul√´t: <span class="low-stock-badge">${lowCount}</span> (‚â§ ${LOW_STOCK_THRESHOLD})`;
  } else {
    lowStockNoticeEl.style.display = 'none';
    lowStockNoticeEl.innerHTML = '';
  }
}
function addProduct(){
  const name = (document.getElementById('pn').value || '').trim();
  const barcode = (document.getElementById('pb').value || '').trim();
  const price = Number(document.getElementById('pp').value) || 0;
  const purchase_price = Number(document.getElementById('pcost').value) || 0;
  const qty = Number(document.getElementById('ps').value) || 0;
  if(!name) return alert('Emri i produktit √´sht√´ i detyruesh√´m');
  if(price <= 0) return alert('√ámimi i shitjes duhet > 0');
  if(purchase_price <= 0) return alert('√ámimi i blerjes duhet > 0');
  if(barcode && products.find(p=>p.b === barcode)) return alert('Barkod ekziston');
  products.push({ n: name, b: barcode, p: price, purchase_price: purchase_price, s: qty });
  storeProducts();
  document.getElementById('pn').value=''; document.getElementById('pb').value=''; document.getElementById('pp').value=''; document.getElementById('pcost').value=''; document.getElementById('ps').value='';
}
function deleteProduct(i){
  if(!confirm('Fshi k√´t√´ produkt?')) return;
  products.splice(i,1);
  storeProducts();
}
function storeProducts(){
  localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products));
  renderProducts();
  initFinanceChart();
}

/* ======= SALES ======= */
function findProductByKey(key){
  if(!key) return null;
  key = key.toString().trim().toLowerCase();
  return products.find(p => p.b && p.b.toString().toLowerCase() === key)
    || products.find(p => (p.n || '').toString().toLowerCase() === key)
    || products.find(p => (p.n || '').toString().toLowerCase().includes(key));
}
function addToSale(p){
  if(p.s < 1) return alert('Stoku = 0');
  let s = sales.find(x=>x.b===p.b);
  if(s){
    if(s.q + 1 > p.s) return alert('Sasia tejkalon stoqen');
    s.q++;
  } else {
    sales.push({ b: p.b, n: p.n, p: p.p, q: 1 });
  }
  drawSale();
}
function manualAdd(){
  let v = saleScanEl.value.trim().toLowerCase();
  if(!v) return;
  const p = findProductByKey(v);
  if(!p){
    showPreview(v,null,false);
    return alert('Nuk u gjet');
  }
  addToSale(p);
  showPreview(v,p,true);
  saleScanEl.value=''; saleScanEl.focus();
}
saleScanEl.addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    e.preventDefault();
    const v = saleScanEl.value.trim();
    if(!v) return;
    const p = products.find(p=>p.b && p.b.toString() === v);
    if(p){
      addToSale(p);
      logRecentScan(v, p);
      showPreview(v, p, true);
      saleScanEl.value='';
      saleScanEl.focus();
    } else {
      const found = findProductByKey(v);
      showPreview(v, found || null, false);
    }
  }
});

function drawSale(){
  saleTableEl.innerHTML = '<tr><th>Produkt</th><th>Sasi</th><th>√ámim</th><th>Total</th><th></th></tr>';
  sales.forEach((x,i)=> {
    saleTableEl.innerHTML += `
      <tr>
        <td>${escapeHtml(x.n)}</td>
        <td><button class="qtyBtn" onclick="changeQty(${i},-1)">‚ûñ</button> ${x.q} <button class="qtyBtn" onclick="changeQty(${i},1)">‚ûï</button></td>
        <td>${x.p}</td>
        <td>${x.q * x.p}</td>
        <td><button onclick="sales.splice(${i},1);drawSale();">üóëÔ∏è</button></td>
      </tr>`;
  });
  recalc();
}
function changeQty(i,delta){
  const item = sales[i]; if(!item) return;
  const prod = products.find(p=>p.b === item.b);
  item.q += delta;
  if(item.q < 1) { sales.splice(i,1); }
  if(prod && item.q > prod.s){ item.q = prod.s; alert('Sasia tejkalon stoqen'); }
  drawSale();
}
function recalc(){
  let total = 0; sales.forEach(x=> total += x.q * x.p);
  totEl.textContent = total;
  const cash = (+paidEl.value || 0);
  const diff = cash - total;
  if(diff < 0){ changeEl.textContent = `Mungojn√´ ${Math.abs(diff)} ALL`; changeEl.style.color = 'red'; }
  else { changeEl.textContent = `Kusur ${diff} ALL`; changeEl.style.color = 'green'; }
}
paidEl.addEventListener('input', recalc);

/* ======= PREVIEW / RECENT SCANS ======= */
let recentScans = JSON.parse(localStorage.getItem(KEY_RECENT_SCANS) || '[]');
function updateRecentScansUI(){
  if(!recentScans.length){ recentScansEl.textContent = 'Skanime t√´ fundit: --'; return; }
  recentScansEl.textContent = 'Skanime t√´ fundit: ' + recentScans.slice(-6).reverse().map(s=> `${s.code}${s.name? ' ('+s.name+')':''}` ).join(' ‚Ä¢ ');
}
function logRecentScan(code, product){
  recentScans.push({ts:new Date().toISOString(), code, name: product ? product.n : null});
  if(recentScans.length > 50) recentScans.shift();
  localStorage.setItem(KEY_RECENT_SCANS, JSON.stringify(recentScans));
  updateRecentScansUI();
}
function showPreview(code, product, added){
  previewCodeEl.textContent = code || '--';
  previewNameEl.textContent = product ? product.n : '--';
  previewPriceEl.textContent = product ? (product.p + ' ALL') : '--';
  previewStockEl.textContent = product ? product.s : '--';
  previewActionsEl.innerHTML = '';
  if(added){
    previewActionsEl.innerHTML = `<span class="preview-added">U shtua 1 cop√´</span> <button onclick="clearPreview()">Anulo</button>`;
    if(code) logRecentScan(code, product);
  } else {
    if(product){
      previewActionsEl.innerHTML = `<button onclick="previewAdd('${escapeForAttr(code)}')">Shto 1</button> <button onclick="clearPreview()">Anulo</button>`;
    } else {
      previewActionsEl.innerHTML = `<span class="preview-missing">Produkt nuk u gjet</span> <button onclick="clearPreview()">Anulo</button>`;
      if(code) logRecentScan(code, null);
    }
  }
}
function clearPreview(){
  previewCodeEl.textContent = '--';
  previewNameEl.textContent = '--';
  previewPriceEl.textContent = '--';
  previewStockEl.textContent = '--';
  previewActionsEl.innerHTML = '';
  saleScanEl.value = '';
  updateRecentScansUI();
}
function previewAdd(code){
  const v = code || saleScanEl.value.trim();
  const p = products.find(p=>p.b && p.b.toString() === v) || findProductByKey(v);
  if(!p) return alert('Produkt nuk u gjet');
  addToSale(p);
  showPreview(v, p, true);
  saleScanEl.value = ''; saleScanEl.focus();
}

/* ======= PAYMENT ======= */
function pay(){
  try{
    const total = +totEl.textContent || 0;
    const cash = +paidEl.value || 0;
    if(sales.length === 0) { alert('Shporta √´sht√´ bosh'); return; }

    const clientName = (document.getElementById('client').value || '').trim();
    const changeAmount = Math.max(0, cash - total);
    const netCollected = Math.min(cash, total);
    const due = Math.max(0, total - cash);
    const status = cash >= total ? 'paid' : 'owed';

    for(const item of sales){
      const prod = products.find(p=>p.b === item.b);
      if(prod) prod.s = Math.max(0, prod.s - item.q);
    }
    storeProducts();

    const timestamp = new Date().toISOString();
    const record = {
      id: timestamp + '_' + Math.random().toString(36).slice(2,7),
      timestamp,
      client: clientName || null,
      items: JSON.parse(JSON.stringify(sales)),
      total,
      amountPaid: netCollected,
      cashGiven: cash,
      change: changeAmount,
      due,
      status
    };

    salesHistory.unshift(record);
    localStorage.setItem(KEY_SALES_HISTORY, JSON.stringify(salesHistory));

    daily += netCollected;
    localStorage.setItem(KEY_DAILY, daily);

    sales = []; cancel();

    updateDaily();
    renderHistory();
    updateFinance();
    initFinanceChart();

    const prodHtml = `<ul class="txn-list">${record.items.map(it=>`<li>${escapeHtml(it.n)} x${it.q} = ${it.q*it.p} ALL</li>`).join('')}</ul>`;
    const html = status==='paid'
      ? `<div style="color:green;font-weight:700;margin-bottom:6px">Transaksioni u mbyll me sukses</div>
         <div><b>Produkte:</b>${prodHtml}</div>
         <div class="txn-summary">Total: ${record.total} ALL</div>
         <div>Klienti dha: ${record.cashGiven} ALL</div>
         <div>Kusur: ${record.change} ALL</div>
         <div class="small" style="margin-top:6px">Shuma e shtuar n√´ ark√´ (neto): ${record.amountPaid} ALL</div>`
      : `<div style="color:#b45f00;font-weight:700;margin-bottom:6px">Shitja u regjistrua si BORXH</div>
         <div><b>Produkte:</b>${prodHtml}</div>
         <div class="txn-summary">Total: ${record.total} ALL</div>
         <div>Paguat tani (neto): ${record.amountPaid} ALL</div>
         <div>Mbetje (borxh): ${record.due} ALL</div>`;
    txnTitleEl.textContent = status==='paid' ? 'Shitje e plot√´' : 'Shitje me borxh';
    showTxn(html);
  }catch(err){
    console.error('Pay error:', err);
    alert('Gabim gjat√´ pages√´s. Shikoni console p√´r detaje.');
  }
}

/* Cancel current sale */
function cancel(){ sales=[]; saleTableEl.innerHTML=''; totEl.textContent=0; paidEl.value=''; changeEl.textContent=0; document.getElementById('client').value=''; clearPreview(); }

/* ======= HISTORY & DEBT ======= */
function renderHistory(){
  histTableEl.innerHTML = '<tr><th>Data</th><th>Klient</th><th>Total</th><th>Paguar(net)</th><th>Mbetje</th><th>Status</th><th>Veprime</th></tr>';
  salesHistory.forEach(rec=>{
    histTableEl.innerHTML += `<tr>
      <td>${rec.timestamp.replace('T',' ').slice(0,19)}</td>
      <td>${escapeHtml(rec.client||'--')}</td>
      <td>${rec.total}</td>
      <td>${rec.amountPaid}</td>
      <td>${rec.due}</td>
      <td>${rec.status}</td>
      <td>
        <button onclick='viewSale("${rec.id}")'>Shiko</button>
        <button onclick='deleteSale("${rec.id}")'>üóëÔ∏è</button>
      </td>
    </tr>`;
  });
}
function viewSale(id){
  const r = salesHistory.find(x=>x.id===id);
  if(!r) return alert('Nuk u gjet shitja');
  const body = document.getElementById('viewBody');
  let html = `<p><b>Data:</b> ${r.timestamp.replace('T',' ').slice(0,19)}</p>`;
  html += `<p><b>Klient:</b> ${escapeHtml(r.client||'--')}</p>`;
  html += `<p><b>Total:</b> ${r.total} ALL</p>`;
  html += `<p><b>Paguar (neto):</b> ${r.amountPaid} ALL</p>`;
  html += `<p><b>Klienti dha:</b> ${r.cashGiven !== undefined ? r.cashGiven + ' ALL' : '--'}</p>`;
  html += `<p><b>Kusur:</b> ${r.change} ALL</p>`;
  html += `<p><b>Mbetje:</b> ${r.due} ALL</p>`;
  html += `<p><b>Status:</b> ${r.status}</p>`;
  html += '<hr><p><b>Produkte:</b></p><ul>';
  r.items.forEach(it=> html += `<li>${escapeHtml(it.n)} x${it.q} = ${it.q*it.p} ALL</li>`);
  html += '</ul>';
  body.innerHTML = html;
  document.getElementById('viewModal').dataset.currentId = id;
  document.getElementById('settleAmount').value = r.due || '';
  document.getElementById('viewModal').style.display='flex';
}
function closeView(){ document.getElementById('viewModal').style.display='none'; delete document.getElementById('viewModal').dataset.currentId; }
function deleteSale(id){
  if(!confirm('Fshi k√´t√´ regjistrim?')) return;
  salesHistory = salesHistory.filter(x=>x.id !== id);
  localStorage.setItem(KEY_SALES_HISTORY, JSON.stringify(salesHistory));
  renderHistory(); updateFinance(); initFinanceChart();
}

/* debt settle */
function settleDebt(){
  const id = document.getElementById('viewModal').dataset.currentId;
  if(!id) return alert('Nuk ka shitje t√´ zgjedhur');
  const r = salesHistory.find(x=>x.id===id);
  if(!r) return alert('Nuk u gjet shitja');
  const amt = +document.getElementById('settleAmount').value || 0;
  if(amt <= 0) return alert('Shuma duhet > 0');
  if(r.due <= 0) return alert('Nuk ka borxh');
  const payNow = Math.min(amt, r.due);
  r.amountPaid += payNow; r.due -= payNow;
  if(r.due <= 0){ r.status='paid'; r.due = 0; } else r.status='owed';
  daily += payNow; localStorage.setItem(KEY_DAILY, daily);
  localStorage.setItem(KEY_SALES_HISTORY, JSON.stringify(salesHistory));
  updateDaily(); renderHistory(); viewSale(id); updateFinance(); initFinanceChart();
  showTxn(`<div style="color:green;font-weight:700">Pagesa u regjistrua</div><div>U mbledh: ${payNow} ALL</div>`);
}

/* ======= EXPORT & CLEAR ======= */
function exportCSV(){
  if(!salesHistory.length) return alert('Nuk ka t√´ dh√´na p√´r eksport');
  const rows = []; rows.push(['id','timestamp','client','total','amountPaid','cashGiven','change','due','status','items'].join(','));
  salesHistory.slice().reverse().forEach(r=>{
    const itemsText = r.items.map(i=>`${i.n} x${i.q}=${i.q*i.p}`).join(' | ');
    const row = [`"${r.id}"`, `"${r.timestamp}"`, `"${r.client||''}"`, r.total, r.amountPaid, r.cashGiven !== undefined ? r.cashGiven : '', r.change, r.due, r.status, `"${itemsText}"`].join(',');
    rows.push(row);
  });
  const csv = rows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'sales_history.csv'; a.click(); URL.revokeObjectURL(url);
}
function clearOld(){
  if(!confirm('Je i sigurt? Kjo do fshij historikun lokal.')) return;
  salesHistory = []; localStorage.removeItem(KEY_SALES_HISTORY); renderHistory(); updateFinance(); initFinanceChart();
}

/* ======= PRODUCTS EXPORT ======= */
function exportProductsCSV(){
  if(!products.length) return alert('Nuk ka produkte p√´r eksport');
  const rows = []; rows.push(['name','barcode','price','purchase_price','stock'].join(','));
  products.forEach(p=>{
    rows.push([`"${p.n||''}"`,`"${p.b||''}"`,p.p||0,p.purchase_price||0,p.s||0].join(','));
  });
  const csv = rows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'products.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ======= BILANCI & SUGGESTIONS EVERY 2 DAYS ======= */
function getLocalDateStr(iso){ const d = new Date(iso); return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'); }
function isSameLocalDate(isoA, isoB){ return getLocalDateStr(isoA) === getLocalDateStr(isoB); }
function aggregateSales(records){ const agg = {}; records.forEach(r=>(r.items||[]).forEach(it=>{ const key = it.b || it.n; if(!agg[key]) agg[key] = {b: it.b, n: it.n, qty:0, revenue:0}; agg[key].qty += it.q; agg[key].revenue += (it.q * it.p); })); return agg; }
function getSalesSinceDays(days){ const cutoff = Date.now() - (days * 24 * 60 * 60 * 1000); return salesHistory.filter(r => new Date(r.timestamp).getTime() >= cutoff); }

/* suggestions generator (7-day average), unchanged */
function generateReorderReport_inner(){
  const last7 = getSalesSinceDays(7); const agg7 = aggregateSales(last7);
  const last14 = getSalesSinceDays(14); const agg14 = aggregateSales(last14);
  const suggestions = [], slowItems = [];
  products.forEach(p=>{
    const key = p.b || p.n; const sold7 = agg7[key] ? agg7[key].qty : 0; const avgDaily7 = sold7 / 7; const leadDaysFactor = 3; const targetStock = Math.ceil(avgDaily7 * leadDaysFactor);
    if(avgDaily7 > 0){
      if(p.s < targetStock){ const suggestedQty = Math.max(1, Math.ceil(avgDaily7 * 7) - p.s); suggestions.push({b:p.b,n:p.n,stock:p.s,avgDaily7:avgDaily7.toFixed(2),suggest: suggestedQty}); }
    } else { if(!agg14[key] || agg14[key].qty === 0) slowItems.push({b:p.b,n:p.n,stock:p.s}); }
  });
  return {suggestions, slowItems};
}

/* when closing day we show suggestions but only if last suggestion was >= 2 days ago */
function closeDay(){
  const sys = daily;
  const arka = +cashRealEl.value || 0;
  const diffv = arka - sys;
  const closures = JSON.parse(localStorage.getItem(KEY_CLOSURES)||'[]');
  const closure = {timestamp:new Date().toISOString(), system:sys, cash:arka, diff:diffv, salesCount: salesHistory.length};
  closures.push(closure); localStorage.setItem(KEY_CLOSURES, JSON.stringify(closures));
  daily = 0; localStorage.setItem(KEY_DAILY, 0); cashRealEl.value=''; updateDaily(); diffEl.textContent = 0;

  // Show short closure report
  const now = new Date(); const todayStr = getLocalDateStr(now.toISOString());
  const todaySales = salesHistory.filter(r => isSameLocalDate(r.timestamp, now.toISOString()));
  const aggToday = aggregateSales(todaySales);
  let soldHtml='', totalQty=0, totalRev=0;
  if(Object.keys(aggToday).length === 0) soldHtml = '<div>Asnj√´ shitje sot.</div>';
  else { soldHtml = '<ul class="txn-list">'; Object.values(aggToday).forEach(item=>{ soldHtml += `<li>${escapeHtml(item.n)} ‚Äî Sasi: ${item.qty} ‚Äî T√´ ardhura: ${item.revenue} ALL</li>`; totalQty += item.qty; totalRev += item.revenue; }); soldHtml += '</ul>'; }
  let topSellerHtml = '<div>Nuk ka t√´ dh√´na p√´r top-seller.</div>'; const itemsArr = Object.values(aggToday); if(itemsArr.length){ itemsArr.sort((a,b)=>b.qty - a.qty); const top = itemsArr[0]; topSellerHtml = `<div class="suggestion"><b>Top Produkt i Sot√´m:</b> ${escapeHtml(top.n)} ‚Äî Sasi: ${top.qty} ‚Äî T√´ ardhura: ${top.revenue} ALL</div>`; }

  const html = `
    <div style="color:green;font-weight:700;margin-bottom:6px">Mbyllje dite</div>
    <div>Shuma n√´ sistem (duhet n√´ ark√´): ${closure.system} ALL</div>
    <div>Arka (me dore): ${closure.cash} ALL</div>
    <div style="margin-top:6px"><b>Diferenca:</b> ${closure.diff} ALL</div>
    <hr>
    <div><b>Raporti i Shitjeve p√´r sot (${todayStr}):</b></div>
    ${soldHtml}
    <div><b>Totali i produkteve te shitura:</b> ${totalQty} ‚Äî <b>T√´ ardhurat:</b> ${totalRev} ALL</div>
    ${topSellerHtml}
  `;
  txnTitleEl.textContent = 'Mbyllje dite'; showTxn(html);

  // suggestions every 2 days: check last suggestion timestamp
  const lastSuggest = localStorage.getItem(KEY_LAST_SUGGEST);
  const nowMs = Date.now();
  const TWO_DAYS_MS = 2 * 24 * 60 * 60 * 1000;
  if(!lastSuggest || (nowMs - new Date(lastSuggest).getTime() >= TWO_DAYS_MS)){
    const rep = generateReorderReport_inner();
    let sHtml = `<div style="color:#0b5cff;font-weight:700;margin-bottom:6px">Sugjerime Riporositjeje (bazuar n√´ 7 dit√´)</div>`;
    if(rep.suggestions.length === 0) sHtml += '<div>Asnj√´ sugjerim p√´r riporositje bazuar n√´ 7-ditoren e fundit.</div>';
    else {
      sHtml += '<div><b>Sugjerime blerjeje:</b></div><ul class="txn-list">';
      rep.suggestions.forEach(s=> sHtml += `<li>${escapeHtml(s.n)} ‚Äî Stok aktual: ${s.stock} ‚Äî Mesatare/dit√´: ${s.avgDaily7} ‚Äî Shto rreth: <b>${s.suggest}</b></li>`);
      sHtml += '</ul>';
    }
    if(rep.slowItems.length){ sHtml += '<div style="margin-top:8px"><b>Produkte pa shitje n√´ 14 dit√´:</b></div><ul class="txn-list">'; rep.slowItems.forEach(si=> sHtml += `<li>${escapeHtml(si.n)} ‚Äî Stok: ${si.stock}</li>`); sHtml += '</ul>'; }
    suggestBodyEl.innerHTML = sHtml;
    suggestModalEl.style.display = 'flex';
    localStorage.setItem(KEY_LAST_SUGGEST, new Date().toISOString());
  } else {
    // skip suggestions (too soon)
    console.log('Sugjerimet jan√´ prodhuar s√´ fundi, do t√´ prodhohen p√´rs√´ri pas 2 dit√´sh.');
  }
}

/* close suggestion modal */
function closeSuggest(){ suggestModalEl.style.display = 'none'; }

/* export closures */
function exportClosuresCSV(){
  const closures = JSON.parse(localStorage.getItem(KEY_CLOSURES)||'[]');
  if(!closures.length) return alert('Nuk ka mbyllje p√´r eksport');
  const rows = []; rows.push(['timestamp','system','cash','diff','salesCount'].join(','));
  closures.forEach(c => rows.push([`"${c.timestamp}"`,c.system,c.cash,c.diff,c.salesCount].join(',')));
  const csv = rows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'closures.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ======= FINANCE (without incomes) ======= */
function computeRevenue(from=null,to=null){
  const fromD = from ? new Date(from) : null; const toD = to ? new Date(to) : null;
  let total = 0;
  salesHistory.forEach(s=>{
    const d = new Date(s.timestamp);
    if(fromD && d < fromD) return;
    if(toD && d > new Date(toD.getTime() + 24*3600*1000 -1)) return;
    total += Number(s.total) || 0;
  });
  return total;
}
function computeCOGS_from_stock(from=null,to=null){
  const fromD = from ? new Date(from) : null; const toD = to ? new Date(to) : null;
  let cogs = 0;
  salesHistory.forEach(s=>{
    const d = new Date(s.timestamp);
    if(fromD && d < fromD) return;
    if(toD && d > new Date(toD.getTime() + 24*3600*1000 -1)) return;
    s.items.forEach(it=>{
      const prod = products.find(p=>p.b === it.b);
      const unitCost = prod ? (Number(prod.purchase_price) || 0) : 0;
      cogs += unitCost * (Number(it.q) || 0);
    });
  });
  return Math.round(cogs);
}
function computeExpenses(from=null,to=null){
  const fromD = from ? new Date(from) : null; const toD = to ? new Date(to) : null;
  let total = 0;
  expenses.forEach(e=>{
    const d = new Date(e.date || e.ts || new Date().toISOString());
    if(fromD && d < fromD) return;
    if(toD && d > new Date(toD.getTime() + 24*3600*1000 -1)) return;
    total += Number(e.amount) || 0;
  });
  return Math.round(total);
}
function updateFinance(){
  const from = document.getElementById('finFrom').value || null;
  const to = document.getElementById('finTo').value || null;
  const revenue = computeRevenue(from,to);
  const cogs = computeCOGS_from_stock(from,to);
  const profitBefore = revenue - cogs;
  const expensesTotal = computeExpenses(from,to);
  const netProfit = profitBefore - expensesTotal; // no separate incomes
  const vat = revenue * (Number(vatRate) || 0) / 100;
  const margin = revenue > 0 ? ((profitBefore / revenue) * 100).toFixed(2) : '0.00';

  document.getElementById('finRevenue').innerText = revenue + ' ALL';
  document.getElementById('finCOGS').innerText = cogs + ' ALL';
  document.getElementById('finProfit').innerText = Math.round(profitBefore) + ' ALL';
  document.getElementById('finMargin').innerText = `Margin√´: ${margin}%`;
  document.getElementById('finExpenses').innerText = expensesTotal + ' ALL';
  document.getElementById('finNetProfit').innerText = Math.round(netProfit) + ' ALL';
  document.getElementById('finVAT').innerText = `TVSH e llogaritur: ${Math.round(vat)} ALL (rate ${vatRate || 0}%)`;

  updateFinanceChart(from,to);
  renderTopProducts(from,to);
}

/* ======= Finance Chart ======= */
function initFinanceChart(){
  const canvas = document.getElementById('finChart');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  if(finChart){ finChart.destroy(); finChart = null; }
  finChart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [
      { label: 'T√´ ardhurat (ALL)', data: [], borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.12)', fill: true },
      { label: 'Fitim (ALL)', data: [], borderColor: '#16a34a', backgroundColor: 'rgba(16,163,74,0.12)', fill: true }
    ]},
    options: {
      responsive: true,
      scales: { x:{ title:{ display:true, text:'Dat√´' }}, y:{ title:{ display:true, text:'ALL' } } },
      plugins: { legend: { position:'top' } }
    }
  });
  updateFinance();
}

function updateFinanceChart(from=null,to=null){
  if(!finChart) initFinanceChart();
  let fromDate = from ? new Date(from) : null;
  let toDate = to ? new Date(to) : null;
  if(!fromDate || !toDate){ toDate = new Date(); fromDate = new Date(); fromDate.setDate(toDate.getDate() - 13); }
  if(fromDate > toDate){ const tmp = fromDate; fromDate = toDate; toDate = tmp; }
  const labels = [];
  const revMap = {}, profitMap = {};
  const dayCount = Math.round((toDate - fromDate) / (24*3600*1000)) + 1;
  for(let i=0;i<dayCount;i++){
    const d = new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate() + i);
    const key = d.toISOString().slice(0,10);
    labels.push(key); revMap[key] = 0; profitMap[key] = 0;
  }
  salesHistory.forEach(s=>{
    const day = s.timestamp.slice(0,10);
    if(!(day in revMap)) return;
    const revenue = Number(s.total) || 0;
    let cogs = 0;
    s.items.forEach(it=>{
      const prod = products.find(p=>p.b === it.b);
      const unitCost = prod ? (Number(prod.purchase_price) || 0) : 0;
      cogs += unitCost * (Number(it.q) || 0);
    });
    revMap[day] += revenue;
    profitMap[day] += (revenue - cogs);
  });
  const revData = labels.map(l=>revMap[l] || 0);
  const profitData = labels.map(l=>profitMap[l] || 0);
  finChart.data.labels = labels;
  finChart.data.datasets[0].data = revData;
  finChart.data.datasets[1].data = profitData;
  finChart.update();
}

/* ======= TOP PRODUCTS ======= */
function renderTopProducts(from=null,to=null){
  const fromD = from ? new Date(from) : null; const toD = to ? new Date(to) : null;
  const agg = {};
  salesHistory.forEach(s=>{
    const d = new Date(s.timestamp);
    if(fromD && d < fromD) return;
    if(toD && d > new Date(toD.getTime() + 24*3600*1000 -1)) return;
    s.items.forEach(it=>{
      const key = it.b || it.n;
      if(!agg[key]) agg[key] = {n: it.n, qty:0, revenue:0, cogs:0};
      agg[key].qty += it.q;
      agg[key].revenue += it.q * it.p;
      const prod = products.find(p=>p.b === it.b);
      const unitCost = prod ? (Number(prod.purchase_price) || 0) : 0;
      agg[key].cogs += unitCost * it.q;
    });
  });
  const arr = Object.values(agg);
  arr.sort((a,b)=>b.revenue - a.revenue);
  let html = '<table class="small-table"><tr><th>Produkt</th><th>Sasi</th><th>T√´ ardhura</th><th>Fitim</th></tr>';
  arr.slice(0,10).forEach(r=> html += `<tr><td>${escapeHtml(r.n)}</td><td>${r.qty}</td><td>${r.revenue}</td><td>${Math.round(r.revenue - r.cogs)}</td></tr>`);
  html += '</table>';
  if(arr.length === 0) html = '<div class="small">Asnj√´ aktivitet p√´r periudh√´n e zgjedhur.</div>';
  topProductsEl.innerHTML = html;
}

/* ======= EXPENSES MANAGEMENT ======= */
function addExpense(){
  const desc = (document.getElementById('expDesc').value || '').trim();
  const amount = Number(document.getElementById('expAmount').value) || 0;
  const date = document.getElementById('expDate').value || new Date().toISOString();
  const category = document.getElementById('expCategory').value || 'other';
  if(!desc) return alert('Vendos p√´rshkrim t√´ shpenzimit');
  if(amount <= 0) return alert('Shuma duhet > 0');
  const rec = { id: new Date().toISOString() + '_' + Math.random().toString(36).slice(2,6), desc, amount, date, category };
  expenses.unshift(rec);
  localStorage.setItem(KEY_EXPENSES, JSON.stringify(expenses));
  document.getElementById('expDesc').value=''; document.getElementById('expAmount').value=''; document.getElementById('expDate').value='';
  renderExpenses();
  updateFinance();
}
function renderExpenses(){
  if(!expenses.length){ expensesListEl.innerHTML = '<div class="small">Nuk ka shpenzime t√´ regjistruara.</div>'; return; }
  let html = '<div>';
  expenses.slice(0,50).forEach(e => {
    html += `<div class="expense-row"><div><b>${escapeHtml(e.desc)}</b><div class="small">${(e.date||'').slice(0,10)} ‚Ä¢ ${escapeHtml(e.category)}</div></div><div>${e.amount} ALL <button onclick="deleteExpense('${e.id}')">üóëÔ∏è</button></div></div>`;
  });
  html += '</div>';
  expensesListEl.innerHTML = html;
}
function deleteExpense(id){
  if(!confirm('Fshi k√´t√´ shpenzim?')) return;
  expenses = expenses.filter(e=>e.id !== id);
  localStorage.setItem(KEY_EXPENSES, JSON.stringify(expenses));
  renderExpenses();
  updateFinance();
}
function exportExpensesCSV(){
  if(!expenses.length) return alert('Nuk ka shpenzime p√´r eksport');
  const rows = []; rows.push(['id','date','desc','category','amount'].join(','));
  expenses.forEach(e => rows.push([`"${e.id}"`,`"${e.date}"`,`"${e.desc.replace(/"/g,'""')}"`,`"${e.category}"`,e.amount].join(',')));
  const csv = rows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'expenses.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ======= RENT / DEBT PLAN ======= */
function saveRentDebt(){
  rentMonthly = Number(document.getElementById('rentMonthly').value) || 0;
  debtTotal = Number(document.getElementById('debtTotal').value) || 0;
  debtDueDays = Number(document.getElementById('debtDueDays').value) || 30;
  localStorage.setItem(KEY_RENT, rentMonthly);
  localStorage.setItem(KEY_DEBT, debtTotal);
  localStorage.setItem(KEY_DEBT_DAYS, debtDueDays);
  alert('Ruajtja u krye');
  computeSavingsPlan();
}
function computeSavingsPlan(){
  const closures = JSON.parse(localStorage.getItem(KEY_CLOSURES) || '[]');
  let dailySales = 0;
  if(closures.length){
    dailySales = Number(closures[closures.length-1].system || 0);
  } else {
    const map = {};
    salesHistory.forEach(s => {
      const day = s.timestamp.slice(0,10);
      map[day] = (map[day] || 0) + (Number(s.amountPaid || s.total) || 0);
    });
    const vals = Object.values(map).slice(-7);
    const sum = vals.reduce((a,b)=>a+b,0);
    dailySales = vals.length ? sum / vals.length : 0;
  }

  const daysInMonth = (new Date()).getDate() > 0 ? new Date((new Date()).getFullYear(), (new Date()).getMonth()+1, 0).getDate() : 30;
  const rentDaily = rentMonthly > 0 ? (rentMonthly / daysInMonth) : 0;
  const debtDaily = debtTotal > 0 ? (debtTotal / (debtDueDays || 1)) : 0;
  const saveDaily = Math.round((rentDaily + debtDaily) * 100) / 100;
  const percentOfDailySales = dailySales > 0 ? Math.round((saveDaily / dailySales) * 10000) / 100 : null;
  const daysToSaveAtCurrent = saveDaily > 0 ? Math.round((rentMonthly + debtTotal) / saveDaily) : null;

  let html = `<div><b>Referenca (shitje ditore):</b> ${Math.round(dailySales)} ALL</div>`;
  html += `<div><b>Qira mujore:</b> ${rentMonthly} ALL ‚Äî <b>Qira/dit√´:</b> ${Math.round(rentDaily*100)/100} ALL</div>`;
  html += `<div><b>Borxh total:</b> ${debtTotal} ALL ‚Äî <b>Shlyerje brenda:</b> ${debtDueDays} dit√´ ‚Äî <b>Borxh/dit√´:</b> ${Math.round(debtDaily*100)/100} ALL</div>`;
  html += `<hr><div><b>Duhet t√´ kursosh/dit√´:</b> <span style="font-weight:700">${saveDaily} ALL</span></div>`;
  if(percentOfDailySales !== null) html += `<div class="small">Kjo √´sht√´ rreth <b>${percentOfDailySales}%</b> e shitjeve ditore (referenc√´)</div>`;
  if(daysToSaveAtCurrent !== null) html += `<div class="small">Me k√´t√´ kursim, do t√´ nevojiten rreth <b>${daysToSaveAtCurrent}</b> dit√´ p√´r t√´ mbledhur qiran√´ + borxhin nj√´her√´sh</div>`;

  savingsResultEl.innerHTML = html;
  const plan = { ts: new Date().toISOString(), refDaily: Math.round(dailySales), rentMonthly, debtTotal, debtDueDays, saveDaily, percentOfDailySales, daysToSaveAtCurrent };
  localStorage.setItem('lastSavingsPlan', JSON.stringify(plan));
  return plan;
}
function exportSavingsCSV(){
  const plan = JSON.parse(localStorage.getItem('lastSavingsPlan') || '{}');
  if(!plan.ts) return alert('S'+"'"+' nuk ka plan t√´ llogaritur. P√´rdorni "Llogarit sa t√´ kursosh" s√´ pari.');
  const rows = []; rows.push(['key','value'].join(','));
  Object.keys(plan).forEach(k => rows.push(`${k},${plan[k]}`));
  const csv = rows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'savings_plan.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ======= FINANCE EXPORT ======= */
function exportFinanceCSV(){
  const from = document.getElementById('finFrom').value || null;
  const to = document.getElementById('finTo').value || null;
  const revenue = computeRevenue(from,to);
  const cogs = computeCOGS_from_stock(from,to);
  const profitBefore = revenue - cogs;
  const expensesTotal = computeExpenses(from,to);
  const netProfit = profitBefore - expensesTotal;
  const vat = revenue * (Number(vatRate) || 0) / 100;

  const rows = [];
  rows.push(['metric','value'].join(','));
  rows.push(['revenue', revenue].join(','));
  rows.push(['cogs', cogs].join(','));
  rows.push(['profit_before_expenses', profitBefore].join(','));
  rows.push(['expenses', expensesTotal].join(','));
  rows.push(['net_profit', netProfit].join(','));
  rows.push(['vat_rate_percent', vatRate || 0].join(','));
  rows.push(['vat_amount', Math.round(vat)].join(','));

  rows.push('');
  rows.push(['Expenses details'].join(','));
  rows.push(['id','date','desc','category','amount'].join(','));
  expenses.forEach(e => rows.push([`"${e.id}"`,`"${e.date}"`,`"${e.desc.replace(/"/g,'""')}"`,`"${e.category}"`,e.amount].join(',')));

  const csv = rows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'finance_report.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ======= VAT SETTINGS persistence ======= */
vatRateEl && vatRateEl.addEventListener('input', ()=> {
  vatRate = Number(vatRateEl.value) || 0;
  localStorage.setItem(KEY_VAT, vatRate);
  updateFinance();
});

/* ======= UTILS ======= */
function updateDaily(){ dailyEl.textContent = daily; }
function showTxn(html){ txnMsgEl.innerHTML = html; txnModalEl.style.display = 'flex'; }
function closeTxn(){ txnModalEl.style.display = 'none'; txnMsgEl.innerHTML = ''; }
function escapeHtml(str){ return ('' + (str || '')).replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
function escapeForAttr(s){ return (''+(s||'')).replace(/'/g,"\\'").replace(/"/g,'\"'); }

/* ======= STORAGE SYNC ACROSS TABS ======= */
window.addEventListener('storage', (e)=>{
  if(e.key === KEY_PRODUCTS){ products = JSON.parse(e.newValue || '[]'); renderProducts(); initFinanceChart(); }
  if(e.key === KEY_SALES_HISTORY){ salesHistory = JSON.parse(e.newValue || '[]'); renderHistory(); updateFinance(); initFinanceChart(); }
  if(e.key === KEY_DAILY){ daily = +e.newValue || 0; updateDaily(); }
  if(e.key === KEY_RECENT_SCANS){ recentScans = JSON.parse(e.newValue || '[]'); updateRecentScansUI(); }
  if(e.key === KEY_EXPENSES){ expenses = JSON.parse(e.newValue || '[]'); renderExpenses(); updateFinance(); }
  if(e.key === KEY_VAT){ vatRate = Number(e.newValue || 0); if(vatRateEl) vatRateEl.value = vatRate; updateFinance(); }
  if(e.key === KEY_RENT){ rentMonthly = Number(e.newValue || 0); document.getElementById('rentMonthly').value = rentMonthly; }
  if(e.key === KEY_DEBT){ debtTotal = Number(e.newValue || 0); document.getElementById('debtTotal').value = debtTotal; }
  if(e.key === KEY_DEBT_DAYS){ debtDueDays = Number(e.newValue || 30); document.getElementById('debtDueDays').value = debtDueDays; }
});

/* ======= INITIALIZE UI ======= */
document.getElementById('u').value = 'admin'; document.getElementById('p').value = 'admin';
renderProducts(); renderHistory(); updateDaily(); initFinanceChart();
recentScans = JSON.parse(localStorage.getItem(KEY_RECENT_SCANS) || '[]');
updateRecentScansUI();

expenses = JSON.parse(localStorage.getItem(KEY_EXPENSES) || '[]');
renderExpenses();

vatRate = Number(localStorage.getItem(KEY_VAT) || 0);
if(vatRateEl) vatRateEl.value = vatRate;

rentMonthly = Number(localStorage.getItem(KEY_RENT) || 0);
debtTotal = Number(localStorage.getItem(KEY_DEBT) || 0);
debtDueDays = Number(localStorage.getItem(KEY_DEBT_DAYS) || 30);

/* Device time display */
function updateDeviceTimeDisplays(){
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const ss = String(now.getSeconds()).padStart(2,'0');
  deviceTimeEl.textContent = `${hh}:${mm}:${ss}`;
  finDeviceTimeEl.textContent = `${hh}:${mm}:${ss}`;
}
setInterval(updateDeviceTimeDisplays, 1000);
updateDeviceTimeDisplays();

/* Live preview while typing */
saleScanEl.addEventListener('input', ()=> {
  const v = saleScanEl.value.trim();
  if(!v){ clearPreview(); return; }
  const found = products.find(p => p.b && p.b.toString() === v) || findProductByKey(v);
  showPreview(v, found || null, false);
});

/* Bilanci: diff updates live when cashReal changes */
cashRealEl && cashRealEl.addEventListener('input', ()=> {
  const arka = +cashRealEl.value || 0;
  diffEl.textContent = (arka - daily);
});

/* Finance date inputs trigger refresh */
document.getElementById('finFrom').addEventListener('change', ()=> updateFinance());
document.getElementById('finTo').addEventListener('change', ()=> updateFinance());

</script>

</body>
</html>